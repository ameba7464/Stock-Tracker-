# üéØ –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

## –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### ‚ùå –ö—Ä–∏—Ç–∏—á–Ω–æ: Race Condition –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å–æ–∑–¥–∞–≤–∞–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç—ã
- –û—à–∏–±–∫–∞: `duplicate key value violates unique constraint "users_telegram_id_key"`
- –ë–æ—Ç –ø–∞–¥–∞–ª –∏ –Ω–µ –æ—Ç–≤–µ—á–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

### ‚ùå –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –ë–î
- –ë–æ—Ç –ø–∞–¥–∞–ª –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–ª—É—á–∞–ª –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã

### ‚ùå –ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- "–ú–µ—Ä—Ç–≤—ã–µ" —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª–∏—Å—å
- –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –ø–∏–∫–æ–≤—ã—Ö –Ω–∞–≥—Ä—É–∑–∫–∞—Ö

## ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `get_or_create_user()`** - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç race condition
2. **–£–ª—É—á—à–µ–Ω–Ω—ã–π Middleware** - –ª–æ–≤–∏—Ç –≤—Å–µ –æ—à–∏–±–∫–∏ –ë–î –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
3. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É–ª PostgreSQL** - `pool_pre_ping`, `pool_recycle`, —É–≤–µ–ª–∏—á–µ–Ω —Ä–∞–∑–º–µ—Ä
4. **–°–∫—Ä–∏–ø—Ç –æ—á–∏—Å—Ç–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤** - `fix_database_duplicates.py`

## üöÄ –ö–∞–∫ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```powershell
cd "C:\Users\miros\Downloads\Stock Tracker\Stock-Tracker\telegram-bot"
.\deploy_fixes.ps1
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –í—Ä—É—á–Ω—É—é

```powershell
# 1. –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
scp app/bot/handlers/registration.py yc-user@158.160.188.247:/opt/stock-tracker-bot/app/bot/handlers/
scp app/database/crud.py yc-user@158.160.188.247:/opt/stock-tracker-bot/app/database/
scp app/database/database.py yc-user@158.160.188.247:/opt/stock-tracker-bot/app/database/
scp app/bot/middlewares/db.py yc-user@158.160.188.247:/opt/stock-tracker-bot/app/bot/middlewares/
scp fix_database_duplicates.py yc-user@158.160.188.247:/opt/stock-tracker-bot/

# 2. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
ssh yc-user@158.160.188.247
cd /opt/stock-tracker-bot
source venv/bin/activate
python fix_database_duplicates.py
# –í–≤–æ–¥–∏–º: yes

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
sudo systemctl restart stock-tracker-bot.service
sudo systemctl status stock-tracker-bot.service
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ  
‚úÖ –ë–æ—Ç –Ω–µ –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ë–î  
‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ  
‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö  

## üìÑ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: [ANALYSIS_AND_FIXES.md](ANALYSIS_AND_FIXES.md)
