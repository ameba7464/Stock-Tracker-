#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Визуализация проблем в коде Stock-Tracker
Генерирует наглядную диаграмму проблем и их влияния
"""

print("""
╔═══════════════════════════════════════════════════════════════════════════════╗
║                   🔍 АНАЛИЗ ПРОБЛЕМ STOCK-TRACKER                             ║
║                        Детальный отчет готов                                  ║
╚═══════════════════════════════════════════════════════════════════════════════╝

📊 ОБНАРУЖЕНО 7 КАТЕГОРИЙ ПРОБЛЕМ:

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 🔴 КРИТИЧЕСКИЕ (требуют немедленного исправления)                           ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

1️⃣  ПЕРИОД УЧЕТА ЗАКАЗОВ
    ├─ Проблема: Трекер учитывает 30 дней, WB статистика - 7 дней
    ├─ Влияние: Заказы в трекере на 24% выше
    ├─ Файл: src/stock_tracker/services/product_service.py:315
    └─ Пример: Its1_2_3/50g → WB: 65, Tracker: 102 (-37 шт)

2️⃣  СКЛАД "МАРКЕТПЛЕЙС" НЕ УЧИТЫВАЕТСЯ
    ├─ Проблема: Код исключает склад "Маркетплейс" из агрегации
    ├─ Влияние: Остатки = 0 для большинства артикулов
    ├─ Файлы: product_service.py:345, calculator.py:47
    └─ Пример: Its1_2_3/50g → WB: 460 шт, Tracker: 0 шт ❌

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 🟠 ВЫСОКИЕ (значительно влияют на данные)                                    ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

3️⃣  НЕПРАВИЛЬНАЯ АГРЕГАЦИЯ FBO + FBS
    ├─ Проблема: total_stock из API, но warehouses неполный
    ├─ Влияние: Несоответствие между total_stock и суммой по складам
    ├─ Файл: product_service.py:450-480
    └─ Пример: total_stock=2815, но Маркетплейс:2665 не в warehouses

4️⃣  НЕВЕРНАЯ ФОРМУЛА ОБОРАЧИВАЕМОСТИ
    ├─ Проблема: turnover = остатки / заказы (без учета периода!)
    ├─ Влияние: Неверные значения оборачиваемости
    ├─ Файл: product_service.py:610-616
    └─ Правильно: turnover = остатки / (заказы_за_период / дней)

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 🟡 СРЕДНИЕ (влияют на качество кода)                                         ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

5️⃣  ПАРСИНГ ДАННЫХ ПО СКЛАДАМ
    ├─ Проблема: Склады/заказы/остатки через пробелы (неточно)
    ├─ Влияние: Невозможно точно сопоставить склад ↔ заказы
    ├─ Файл: compare_wb_vs_tracker_30_10.py:95
    └─ Пример: "Чехов 1" → ["Чехов", "1"] (разные элементы)

6️⃣  ДУБЛИРОВАНИЕ КОДА
    ├─ Проблема: 4+ версии функций синхронизации
    ├─ Влияние: Непонятно какая версия используется
    ├─ Файлы: operations.py, product_service.py, dual_api_sync_patch.py
    └─ Версии: refresh_table_data(), sync_from_api_to_sheets(), ...

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 🟢 НИЗКИЕ (косметические)                                                    ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

7️⃣  ФОРМАТИРОВАНИЕ GOOGLE SHEETS
    ├─ Проблема: Числа без пробелов, multi-line не работает
    ├─ Влияние: Визуальные различия с WB статистикой
    ├─ Файл: operations.py
    └─ Пример: WB: "3 184", Tracker: "3184"

═══════════════════════════════════════════════════════════════════════════════

📈 ВЛИЯНИЕ НА ТОЧНОСТЬ ДАННЫХ:

┌─────────────────────────┬──────────┬──────────┬─────────────┐
│ Метрика                 │ WB       │ Tracker  │ Расхождение │
├─────────────────────────┼──────────┼──────────┼─────────────┤
│ Заказы (всего)          │ 189 шт   │ 248 шт   │ -24% ❌     │
│ Остатки (всего)         │ 1195 шт  │ 1355 шт  │ -13% ❌     │
│ Артикулов с ошибками    │          │          │             │
│  - по заказам           │          │ 7/12     │ 58% ❌      │
│  - по остаткам          │          │ 11/12    │ 92% ❌❌❌   │
└─────────────────────────┴──────────┴──────────┴─────────────┘

═══════════════════════════════════════════════════════════════════════════════

🎯 ПЛАН ДЕЙСТВИЙ:

✅ ПРИОРИТЕТ 1 (СЕГОДНЯ):
   1. Изменить ORDER_LOOKBACK_DAYS с 30 → 7 дней
   2. Включить склад "Маркетплейс" в агрегацию
   3. Синхронизировать warehouses с total_stock

✅ ПРИОРИТЕТ 2 (1-2 ДНЯ):
   4. Исправить формулу оборачиваемости
   5. Улучшить парсинг данных по складам

✅ ПРИОРИТЕТ 3 (1 НЕДЕЛЯ):
   6. Удалить дублирующийся код
   7. Улучшить форматирование Google Sheets

═══════════════════════════════════════════════════════════════════════════════

📊 ОЖИДАЕМЫЕ РЕЗУЛЬТАТЫ ПОСЛЕ ИСПРАВЛЕНИЙ:

Заказы:     WB ≈ Tracker  (точность > 95%)
Остатки:    WB ≈ Tracker  (точность > 95%)
Warehouse:  Все склады учитываются, включая Маркетплейс
Turnover:   Правильная формула с учетом периода

═══════════════════════════════════════════════════════════════════════════════

📄 Детальный отчет: CODE_ANALYSIS_DETAILED_REPORT.md

🔧 Готовы начать исправления? (y/n)
""")

print("\n" + "="*79)
print("💡 ДЛЯ ДЕТАЛЬНОЙ ИНФОРМАЦИИ см. CODE_ANALYSIS_DETAILED_REPORT.md")
print("="*79 + "\n")
