# üö® –ü–†–û–ú–ü–¢ –î–õ–Ø –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô STOCK TRACKER

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 24 –æ–∫—Ç—è–±—Ä—è 2025 –≥.  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô  
**–û—Å–Ω–æ–≤–∞**: –ê–Ω–∞–ª–∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö Wildberries –∑–∞ –ø–µ—Ä–∏–æ–¥ 18-24 –æ–∫—Ç—è–±—Ä—è 2025  

## üéØ –û–ü–ò–°–ê–ù–ò–ï –ü–†–û–ë–õ–ï–ú

–ù–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ Wildberries –≤—ã—è–≤–ª–µ–Ω—ã **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è** –≤ –∞–ª–≥–æ—Ä–∏—Ç–º–µ Stock Tracker, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –Ω–µ—Ç–æ—á–Ω—ã–º –¥–∞–Ω–Ω—ã–º –∏ –ø–æ—Ç–µ—Ä–µ –¥–æ–≤–µ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

### ‚ùå –ü–†–û–ë–õ–ï–ú–ê 1: –ü–æ–ª–Ω–æ–µ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞ "–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å"

**–û–ø–∏—Å–∞–Ω–∏–µ**: Stock Tracker **–ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç** —Å–∫–ª–∞–¥ "–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å", —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫:
- –ü–æ—Ç–µ—Ä–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ FBS —Ç–æ–≤–∞—Ä–æ–≤
- –ù–µ—É—á–µ—Ç—É –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–π —á–∞—Å—Ç–∏ –∑–∞–∫–∞–∑–æ–≤
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è–º –º–µ–∂–¥—É —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞**: 
- –§—É–Ω–∫—Ü–∏—è `is_real_warehouse()` –∏—Å–∫–ª—é—á–∞–µ—Ç —Å–∫–ª–∞–¥—ã —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–º–∏ "–º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å"
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤ `group_data_by_product()` –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤–∞–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ FBS —Ç–æ–≤–∞—Ä–æ–≤

### ‚ùå –ü–†–û–ë–õ–ï–ú–ê 2: –û—à–∏–±–∫–∏ –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–æ–≤ –ø–æ —Å–∫–ª–∞–¥–∞–º

**–û–ø–∏—Å–∞–Ω–∏–µ**: –ó–∞–∫–∞–∑—ã –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –º–µ–∂–¥—É –æ–¥–Ω–æ–∏–º–µ–Ω–Ω—ã–º–∏ —Å–∫–ª–∞–¥–∞–º–∏.

**–ü—Ä–∏–º–µ—Ä**: 
- –°–∫–ª–∞–¥ "–ß–µ—Ö–æ–≤ 1" –¥–ª—è –∞—Ä—Ç–∏–∫—É–ª–∞ Its1_2_3/50g
- WB –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: **5 –∑–∞–∫–∞–∑–æ–≤**
- Stock Tracker –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: **49 –∑–∞–∫–∞–∑–æ–≤** 
- **–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ: -44 –∑–∞–∫–∞–∑–∞**

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞**:
- –ù–µ—Ç–æ—á–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–∫–ª–∞–¥–æ–≤ –∏ –∞—Ä—Ç–∏–∫—É–ª–æ–≤
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Å—á–µ—Ç–æ–≤ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `calculate_warehouse_orders()`
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### ‚ùå –ü–†–û–ë–õ–ï–ú–ê 3: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑-–∑–∞ —Ä–∞–∑–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π —Å–∫–ª–∞–¥–æ–≤

**–û–ø–∏—Å–∞–Ω–∏–µ**: –†–∞–∑–ª–∏—á–∏—è –≤ –Ω–∞–∑–≤–∞–Ω–∏—è—Ö —Å–∫–ª–∞–¥–æ–≤ –º–µ–∂–¥—É WB –∏ Stock Tracker –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—é.

**–ü—Ä–∏–º–µ—Ä—ã**:
- WB: "–ù–æ–≤–æ—Å–µ–º–µ–π–∫–∏–Ω–æ" ‚Üí Stock Tracker: "–°–∞–º–∞—Ä–∞ (–ù–æ–≤–æ—Å–µ–º–µ–π–∫–∏–Ω–æ)"
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –∏ –Ω–µ—Ç–æ—á–Ω—ã–π —É—á–µ—Ç

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞**:
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π —Å–∫–ª–∞–¥–æ–≤
- –ù–µ—Ç –µ–¥–∏–Ω–æ–≥–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç "—Ñ–∞—Å–µ—Ç–Ω–æ–µ" —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –∫–ª—é—á–µ–≤—ã–º —á–∞—Å—Ç—è–º –Ω–∞–∑–≤–∞–Ω–∏–π

### ‚ùå –ü–†–û–ë–õ–ï–ú–ê 4: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç –æ—Å—Ç–∞—Ç–∫–æ–≤ FBS —Ç–æ–≤–∞—Ä–æ–≤

**–û–ø–∏—Å–∞–Ω–∏–µ**: FBS —Ç–æ–≤–∞—Ä—ã —Ç—Ä–µ–±—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ —É—á–µ—Ç–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ –¥–∞–Ω–Ω—ã–º WB, –Ω–æ –∞–ª–≥–æ—Ä–∏—Ç–º –∏—Ö —Ç–µ—Ä—è–µ—Ç.

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞**:
- –°–∫–ª–∞–¥—ã FBS –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è –∫–∞–∫ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏—Å–∫–ª—é—á–∞–µ—Ç —Å–∫–ª–∞–¥—ã –ø—Ä–æ–¥–∞–≤—Ü–∞
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è FBS —Ç–æ–≤–∞—Ä–æ–≤

## üîß –¢–†–ï–ë–£–ï–ú–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. ‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô –£–ß–ï–¢ –°–ö–õ–ê–î–ê "–ú–ê–†–ö–ï–¢–ü–õ–ï–ô–°"

#### 1.1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–∫–ª–∞–¥–æ–≤

**–§–∞–π–ª**: `src/stock_tracker/core/calculator.py`

**–ó–∞–º–µ–Ω–∏—Ç—å –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `is_real_warehouse()`**:

```python
def is_real_warehouse(warehouse_name: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —ç—Ç–æ —Ä–µ–∞–ª—å–Ω—ã–π —Å–∫–ª–∞–¥, –∞ –Ω–µ —Å—Ç–∞—Ç—É—Å."""
    if not warehouse_name or not isinstance(warehouse_name, str):
        return False
    
    # –ò—Å–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –¥–æ—Å—Ç–∞–≤–∫–∏
    if warehouse_name in DELIVERY_STATUSES:
        return False
        
    # –ò—Å–∫–ª—é—á–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏
    if any(word in warehouse_name.lower() for word in ["–∏—Ç–æ–≥", "–≤—Å–µ–≥–æ", "–æ–±—â–∏–π"]):
        return False
        
    # –ò—Å–∫–ª—é—á–∞–µ–º —Å—Ç—Ä–æ–∫–∏ "–≤ –ø—É—Ç–∏"
    if "–≤ –ø—É—Ç–∏" in warehouse_name.lower():
        return False
    
    # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤–∫–ª—é—á–∞–µ–º —Å–∫–ª–∞–¥ "–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å"
    warehouse_name_lower = warehouse_name.lower()
    
    # –¢–æ—á–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–∫–ª–∞–¥–∞ –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å (FBS)
    marketplace_indicators = [
        "–º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å", "marketplace", 
        "—Å–∫–ª–∞–¥ –ø—Ä–æ–¥–∞–≤—Ü–∞", "—Å–∫–ª–∞–¥ —Å–µ–ª–ª–µ—Ä–∞", 
        "fbs", "fulfillment by seller",
        "–º–ø ", "mp ", "—Å–ø "
    ]
    
    # –ï—Å–ª–∏ —ç—Ç–æ —Å–∫–ª–∞–¥ –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å - –í–°–ï–ì–î–ê –≤–∫–ª—é—á–∞–µ–º
    if any(indicator in warehouse_name_lower for indicator in marketplace_indicators):
        logger.info(f"‚úÖ CRITICAL: Marketplace warehouse INCLUDED: {warehouse_name}")
        return True
    
    # –ù–û–í–û–ï: –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è "–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å"
    if warehouse_name_lower.strip() == "–º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å":
        logger.info(f"‚úÖ CRITICAL: Exact Marketplace warehouse INCLUDED: {warehouse_name}")
        return True
    
    # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤ - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
    return validate_warehouse_name(warehouse_name)
```

#### 1.2. –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É warehouseType –≤ API –¥–∞–Ω–Ω—ã—Ö

**–§–∞–π–ª**: `src/stock_tracker/core/calculator.py`

**–î–æ–±–∞–≤–∏—Ç—å –≤ —Ñ—É–Ω–∫—Ü–∏—é `group_data_by_product()`**:

```python
# Process orders data - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤–∫–ª—é—á–∞–µ–º FBS —Å–∫–ª–∞–¥—ã
for order in orders_data:
    nm_id = order.get("nmId")
    supplier_article = order.get("supplierArticle", "")
    warehouse_name = order.get("warehouseName", "")
    warehouse_type = order.get("warehouseType", "")  # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û
    
    if nm_id and supplier_article:
        key = (supplier_article, nm_id)
        group = grouped_data[key]
        
        # Count total orders
        group["total_orders"] += 1
        
        # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∫–ª–∞–¥–æ–≤ –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å
        if warehouse_name:
            # –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è FBS/–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å
            is_marketplace = (
                warehouse_type == "–°–∫–ª–∞–¥ –ø—Ä–æ–¥–∞–≤—Ü–∞" or
                "–º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å" in warehouse_name.lower() or
                "marketplace" in warehouse_name.lower()
            )
            
            # –í–°–ï–ì–î–ê –≤–∫–ª—é—á–∞–µ–º —Å–∫–ª–∞–¥—ã –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å
            if is_marketplace:
                logger.info(f"‚úÖ FBS/Marketplace warehouse detected: {warehouse_name} (type: {warehouse_type})")
                
                if warehouse_name not in group["warehouses"]:
                    group["warehouses"][warehouse_name] = {
                        "stock": 0,
                        "orders": 0,
                        "warehouse_type": warehouse_type,
                        "is_fbs": True  # –ú–∞—Ä–∫–µ—Ä FBS —Å–∫–ª–∞–¥–∞
                    }
                
                group["warehouses"][warehouse_name]["orders"] += 1
                
            # –û–±—ã—á–Ω—ã–µ —Å–∫–ª–∞–¥—ã WB —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
            elif warehouse_type == "–°–∫–ª–∞–¥ WB" and is_real_warehouse(warehouse_name):
                if warehouse_name not in group["warehouses"]:
                    group["warehouses"][warehouse_name] = {
                        "stock": 0,
                        "orders": 0,
                        "warehouse_type": warehouse_type,
                        "is_fbs": False
                    }
                
                group["warehouses"][warehouse_name]["orders"] += 1
                
            else:
                logger.warning(f"‚ö†Ô∏è Filtered out warehouse: {warehouse_name} (type: {warehouse_type})")
```

### 2. ‚úÖ –ò–°–ü–†–ê–í–ò–¢–¨ –¢–û–ß–ù–û–°–¢–¨ –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –ó–ê–ö–ê–ó–û–í

#### 2.1. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø–æ–¥—Å—á–µ—Ç–æ–≤

**–§–∞–π–ª**: `src/stock_tracker/core/calculator.py`

**–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥**:

```python
@staticmethod
def validate_warehouse_orders_accuracy(orders_data: List[Dict[str, Any]], 
                                     nm_id: int, 
                                     calculated_breakdown: Dict[str, int]) -> Dict[str, Any]:
    """
    –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø–æ —Å–∫–ª–∞–¥–∞–º.
    
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ —Å—É–º–º–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ —Å–∫–ª–∞–¥–∞–º —Ç–æ—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç 
    –æ–±—â–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è —Ç–æ–≤–∞—Ä–∞.
    """
    # –ü–æ–¥—Å—á–µ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è nmId
    total_orders_actual = sum(
        1 for order in orders_data 
        if order.get("nmId") == nm_id and not order.get("isCancel", False)
    )
    
    # –°—É–º–º–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ —Å–∫–ª–∞–¥–∞–º
    total_orders_calculated = sum(calculated_breakdown.values())
    
    validation = {
        "nm_id": nm_id,
        "total_actual": total_orders_actual,
        "total_calculated": total_orders_calculated,
        "difference": abs(total_orders_actual - total_orders_calculated),
        "is_accurate": total_orders_actual == total_orders_calculated,
        "accuracy_percent": (min(total_orders_actual, total_orders_calculated) / 
                           max(total_orders_actual, total_orders_calculated) * 100) 
                           if max(total_orders_actual, total_orders_calculated) > 0 else 100,
        "warehouse_breakdown": calculated_breakdown
    }
    
    if not validation["is_accurate"]:
        logger.error(f"‚ùå ACCURACY ERROR for nmId {nm_id}:")
        logger.error(f"   Expected: {total_orders_actual} orders")
        logger.error(f"   Calculated: {total_orders_calculated} orders") 
        logger.error(f"   Difference: {validation['difference']}")
        logger.error(f"   Warehouse breakdown: {calculated_breakdown}")
    else:
        logger.info(f"‚úÖ ACCURACY VALIDATED for nmId {nm_id}: {total_orders_actual} orders")
    
    return validation
```

#### 2.2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ–¥—Å—á–µ—Ç–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ —Å–∫–ª–∞–¥–∞–º

**–§–∞–π–ª**: `src/stock_tracker/core/calculator.py`

**–ó–∞–º–µ–Ω–∏—Ç—å –º–µ—Ç–æ–¥ `calculate_warehouse_orders()`**:

```python
@staticmethod
def calculate_warehouse_orders(orders_data: List[Dict[str, Any]], 
                             nm_id: int, warehouse_name: str) -> int:
    """
    Calculate orders for specific warehouse with improved accuracy.
    
    –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –¢–æ—á–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è.
    """
    order_count = 0
    debug_matches = []
    
    for i, order in enumerate(orders_data):
        # –¢–æ—á–Ω–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
        order_nm_id = order.get("nmId")
        order_warehouse = order.get("warehouseName", "").strip()
        is_canceled = order.get("isCancel", False)
        
        # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –¢–æ—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
        if (order_nm_id == nm_id and 
            order_warehouse == warehouse_name and 
            not is_canceled):
            
            order_count += 1
            debug_matches.append({
                "index": i,
                "date": order.get("date", ""),
                "warehouse_type": order.get("warehouseType", "")
            })
    
    logger.debug(f"Warehouse orders for nmId {nm_id}, warehouse '{warehouse_name}': {order_count}")
    logger.debug(f"Debug matches: {debug_matches[:3]}...")  # –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–≤—ã–µ 3
    
    return order_count
```

### 3. ‚úÖ –î–û–ë–ê–í–ò–¢–¨ –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Æ –ù–ê–ó–í–ê–ù–ò–ô –°–ö–õ–ê–î–û–í

#### 3.1. –°–æ–∑–¥–∞—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª**: `src/stock_tracker/utils/warehouse_mapper.py`

```python
"""
–ú–æ–¥—É–ª—å –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π —Å–∫–ª–∞–¥–æ–≤.

–†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑-–∑–∞ —Ä–∞–∑–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –æ–¥–Ω–∏—Ö –∏ —Ç–µ—Ö –∂–µ —Å–∫–ª–∞–¥–æ–≤
–≤ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö –¥–∞–Ω–Ω—ã—Ö.
"""

import re
from typing import Dict, List, Optional, Tuple
from stock_tracker.utils.logger import get_logger

logger = get_logger(__name__)

# –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –Ω–∞–∑–≤–∞–Ω–∏–π —Å–∫–ª–∞–¥–æ–≤
WAREHOUSE_NAME_MAPPINGS = {
    # –§–æ—Ä–º–∞—Ç: "–Ω–∞–∑–≤–∞–Ω–∏–µ_–≤_wb": ["–≤–æ–∑–º–æ–∂–Ω—ã–µ_–≤–∞—Ä–∏–∞–Ω—Ç—ã_–≤_stock_tracker"]
    "–ù–æ–≤–æ—Å–µ–º–µ–π–∫–∏–Ω–æ": ["–°–∞–º–∞—Ä–∞ (–ù–æ–≤–æ—Å–µ–º–µ–π–∫–∏–Ω–æ)", "–°–∞–º–∞—Ä–∞ –ù–æ–≤–æ—Å–µ–º–µ–π–∫–∏–Ω–æ", "–ù–æ–≤–æ—Å–µ–º–µ–π–∫–∏–Ω–æ"],
    "–ß–µ—Ö–æ–≤": ["–ß–µ—Ö–æ–≤ 1", "–ß–µ—Ö–æ–≤-1", "–ß–µ—Ö–æ–≤ (–§–∏–ª–∏–∞–ª)"],
    "–ü–æ–¥–æ–ª—å—Å–∫": ["–ü–æ–¥–æ–ª—å—Å–∫ 3", "–ü–æ–¥–æ–ª—å—Å–∫-3", "–ü–æ–¥–æ–ª—å—Å–∫ (–§–∏–ª–∏–∞–ª)"],
    "–î–æ–º–æ–¥–µ–¥–æ–≤–æ": ["–î–æ–º–æ–¥–µ–¥–æ–≤–æ", "–î–æ–º–æ–¥–µ–¥–æ–≤–æ (–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å)"],
    "–¢—É–ª–∞": ["–¢—É–ª–∞", "–¢—É–ª–∞ (–§–∏–ª–∏–∞–ª)"],
    "–ë–µ–ª—ã–µ –°—Ç–æ–ª–±—ã": ["–ë–µ–ª—ã–µ –°—Ç–æ–ª–±—ã", "–ë–µ–ª—ã–µ —Å—Ç–æ–ª–±—ã"],
    "–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–ª—å": ["–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–ª—å", "–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–ª—å (–ú–û)"],
    "–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å": ["–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å", "Marketplace", "–°–∫–ª–∞–¥ –ø—Ä–æ–¥–∞–≤—Ü–∞", "–ú–ü"]
}

class WarehouseNameMapper:
    """–ö–ª–∞—Å—Å –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π —Å–∫–ª–∞–¥–æ–≤."""
    
    def __init__(self):
        self.mapping_cache = {}
        self.reverse_mapping = self._build_reverse_mapping()
    
    def _build_reverse_mapping(self) -> Dict[str, str]:
        """–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫: –≤–∞—Ä–∏–∞–Ω—Ç -> –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π."""
        reverse = {}
        
        for canonical, variants in WAREHOUSE_NAME_MAPPINGS.items():
            for variant in variants:
                reverse[variant.lower().strip()] = canonical
                
        return reverse
    
    def normalize_warehouse_name(self, warehouse_name: str) -> str:
        """
        –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞ –∫ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–º—É –≤–∏–¥—É.
        
        Args:
            warehouse_name: –ò—Å—Ö–æ–¥–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞
            
        Returns:
            –ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞
        """
        if not warehouse_name:
            return warehouse_name
            
        original = warehouse_name.strip()
        normalized_key = original.lower()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
        if normalized_key in self.mapping_cache:
            return self.mapping_cache[normalized_key]
        
        # –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
        if normalized_key in self.reverse_mapping:
            canonical = self.reverse_mapping[normalized_key]
            self.mapping_cache[normalized_key] = canonical
            logger.debug(f"Mapped '{original}' -> '{canonical}' (exact)")
            return canonical
        
        # –ò—â–µ–º —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ (—Ñ–∞—Å–µ—Ç–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ)
        canonical = self._find_partial_match(original)
        if canonical:
            self.mapping_cache[normalized_key] = canonical
            logger.debug(f"Mapped '{original}' -> '{canonical}' (partial)")
            return canonical
        
        # –ï—Å–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ
        self.mapping_cache[normalized_key] = original
        return original
    
    def _find_partial_match(self, warehouse_name: str) -> Optional[str]:
        """
        –ù–∞–π—Ç–∏ —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º.
        
        Args:
            warehouse_name: –ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
            
        Returns:
            –ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ None
        """
        name_lower = warehouse_name.lower()
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (—É–±–∏—Ä–∞–µ–º —Å–∫–æ–±–∫–∏, –Ω–æ–º–µ—Ä–∞, —Ñ–∏–ª–∏–∞–ª—ã)
        clean_name = re.sub(r'\s*\([^)]*\)', '', name_lower)  # –£–±–∏—Ä–∞–µ–º —Å–∫–æ–±–∫–∏
        clean_name = re.sub(r'\s*-?\d+\s*', ' ', clean_name)  # –£–±–∏—Ä–∞–µ–º –Ω–æ–º–µ—Ä–∞
        clean_name = re.sub(r'\s*(—Ñ–∏–ª–∏–∞–ª|—Ñ–∏–ª\.?)\s*', ' ', clean_name)  # –£–±–∏—Ä–∞–µ–º "—Ñ–∏–ª–∏–∞–ª"
        clean_name = ' '.join(clean_name.split())  # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—Ä–æ–±–µ–ª—ã
        
        # –ò—â–µ–º –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
        for canonical, variants in WAREHOUSE_NAME_MAPPINGS.items():
            canonical_clean = canonical.lower()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ö–æ–∂–¥–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
            if canonical_clean in clean_name or clean_name in canonical_clean:
                return canonical
                
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å–ª–æ–≤
            canonical_words = set(canonical_clean.split())
            name_words = set(clean_name.split())
            
            if canonical_words & name_words:  # –ï—Å—Ç—å –æ–±—â–∏–µ —Å–ª–æ–≤–∞
                return canonical
        
        return None
    
    def get_warehouse_group(self, warehouse_names: List[str]) -> Dict[str, List[str]]:
        """
        –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è —Å–∫–ª–∞–¥–æ–≤ –ø–æ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏—è–º.
        
        Args:
            warehouse_names: –°–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π —Å–∫–ª–∞–¥–æ–≤
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å: –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–µ_–Ω–∞–∑–≤–∞–Ω–∏–µ -> [–∏—Å—Ö–æ–¥–Ω—ã–µ_–Ω–∞–∑–≤–∞–Ω–∏—è]
        """
        groups = {}
        
        for name in warehouse_names:
            canonical = self.normalize_warehouse_name(name)
            
            if canonical not in groups:
                groups[canonical] = []
            
            if name not in groups[canonical]:
                groups[canonical].append(name)
        
        return groups
    
    def validate_mapping_accuracy(self, wb_names: List[str], 
                                st_names: List[str]) -> Dict[str, any]:
        """
        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ—á–Ω–æ—Å—Ç—å —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –º–µ–∂–¥—É WB –∏ Stock Tracker –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏.
        
        Args:
            wb_names: –ù–∞–∑–≤–∞–Ω–∏—è –∏–∑ Wildberries
            st_names: –ù–∞–∑–≤–∞–Ω–∏—è –∏–∑ Stock Tracker
            
        Returns:
            –û—Ç—á–µ—Ç –æ —Ç–æ—á–Ω–æ—Å—Ç–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
        """
        wb_normalized = [self.normalize_warehouse_name(name) for name in wb_names]
        st_normalized = [self.normalize_warehouse_name(name) for name in st_names]
        
        wb_set = set(wb_normalized)
        st_set = set(st_normalized)
        
        matched = wb_set & st_set
        wb_only = wb_set - st_set
        st_only = st_set - wb_set
        
        accuracy = len(matched) / len(wb_set) if wb_set else 0
        
        return {
            "total_wb_warehouses": len(wb_set),
            "total_st_warehouses": len(st_set),
            "matched_warehouses": len(matched),
            "wb_only_warehouses": list(wb_only),
            "st_only_warehouses": list(st_only),
            "accuracy_percent": accuracy * 100,
            "mapping_details": {
                "matched": list(matched),
                "wb_only": list(wb_only),
                "st_only": list(st_only)
            }
        }


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
warehouse_mapper = WarehouseNameMapper()


def normalize_warehouse_name(warehouse_name: str) -> str:
    """–£–¥–æ–±–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞–∑–≤–∞–Ω–∏—è —Å–∫–ª–∞–¥–∞."""
    return warehouse_mapper.normalize_warehouse_name(warehouse_name)


def validate_warehouse_mapping(wb_names: List[str], st_names: List[str]) -> Dict[str, any]:
    """–£–¥–æ–±–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–∫–ª–∞–¥–æ–≤."""
    return warehouse_mapper.validate_mapping_accuracy(wb_names, st_names)
```

#### 3.2. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º

**–§–∞–π–ª**: `src/stock_tracker/core/calculator.py`

**–î–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**:

```python
from stock_tracker.utils.warehouse_mapper import normalize_warehouse_name

# –í —Ñ—É–Ω–∫—Ü–∏–∏ group_data_by_product() –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π:
for warehouse in item["warehouses"]:
    warehouse_name_raw = warehouse.get("warehouseName", "")
    # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
    warehouse_name = normalize_warehouse_name(warehouse_name_raw)
    quantity = warehouse.get("quantity", 0)
    
    if warehouse_name and is_real_warehouse(warehouse_name):
        # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
```

### 4. ‚úÖ –°–ü–ï–¶–ò–ê–õ–¨–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê FBS –¢–û–í–ê–†–û–í

#### 4.1. –î–æ–±–∞–≤–∏—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ FBS —Ç–æ–≤–∞—Ä–æ–≤

**–§–∞–π–ª**: `src/stock_tracker/core/calculator.py`

**–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã**:

```python
@staticmethod
def is_fbs_warehouse(warehouse_name: str, warehouse_type: str = "") -> bool:
    """
    –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–∫–ª–∞–¥ FBS (Fulfillment by Seller).
    
    FBS —Å–∫–ª–∞–¥—ã –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö.
    """
    if not warehouse_name:
        return False
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Å–∫–ª–∞–¥–∞
    if warehouse_type == "–°–∫–ª–∞–¥ –ø—Ä–æ–¥–∞–≤—Ü–∞":
        return True
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
    warehouse_lower = warehouse_name.lower()
    fbs_indicators = [
        "–º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å", "marketplace",
        "—Å–∫–ª–∞–¥ –ø—Ä–æ–¥–∞–≤—Ü–∞", "—Å–∫–ª–∞–¥ —Å–µ–ª–ª–µ—Ä–∞",
        "fbs", "fulfillment"
    ]
    
    return any(indicator in warehouse_lower for indicator in fbs_indicators)

@staticmethod
def ensure_fbs_warehouse_inclusion(grouped_data: Dict[Tuple[str, int], Dict[str, Any]]) -> None:
    """
    –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ—Ö FBS —Å–∫–ª–∞–¥–æ–≤ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.
    
    –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: FBS –æ—Å—Ç–∞—Ç–∫–∏ –Ω–µ –¥–æ–ª–∂–Ω—ã —Ç–µ—Ä—è—Ç—å—Å—è.
    """
    for product_key, product_data in grouped_data.items():
        fbs_warehouses = []
        
        for warehouse_name, warehouse_info in product_data["warehouses"].items():
            if warehouse_info.get("is_fbs", False):
                fbs_warehouses.append(warehouse_name)
        
        if fbs_warehouses:
            logger.info(f"‚úÖ FBS warehouses ensured for {product_key}: {fbs_warehouses}")
        else:
            logger.warning(f"‚ö†Ô∏è No FBS warehouses found for {product_key}")
```

## üß™ –°–û–ó–î–ê–¢–¨ –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò

### –£—Ç–∏–ª–∏—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª**: `diagnose_critical_issues.py`

```python
#!/usr/bin/env python3
"""
–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º Stock Tracker.

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–ª—É—á–∞–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π —Å WB –¥–∞–Ω–Ω—ã–º–∏.
"""

import asyncio
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent / "src"))

from stock_tracker.api.client import WildberriesAPIClient
from stock_tracker.core.calculator import WildberriesCalculator
from stock_tracker.utils.warehouse_mapper import validate_warehouse_mapping
from stock_tracker.utils.config import get_config
from stock_tracker.utils.logger import setup_logging, get_logger

logger = get_logger(__name__)

async def diagnose_marketplace_warehouse_issue():
    """–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å–æ —Å–∫–ª–∞–¥–æ–º –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å."""
    logger.info("üîç DIAGNOSING: Marketplace warehouse inclusion")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é —Å–∫–ª–∞–¥–∞ –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å
    from stock_tracker.core.calculator import is_real_warehouse
    
    test_cases = [
        "–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å",
        "–º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å", 
        "Marketplace",
        "–°–∫–ª–∞–¥ –ø—Ä–æ–¥–∞–≤—Ü–∞",
        "–ú–ü-1",
        "FBS —Å–∫–ª–∞–¥"
    ]
    
    print("üè≠ Testing Marketplace warehouse detection:")
    for warehouse_name in test_cases:
        is_included = is_real_warehouse(warehouse_name)
        status = "‚úÖ INCLUDED" if is_included else "‚ùå EXCLUDED"
        print(f"   {status}: '{warehouse_name}'")
        
        if "–º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å" in warehouse_name.lower() and not is_included:
            print(f"   üö® CRITICAL ERROR: Marketplace warehouse excluded!")

async def diagnose_orders_accuracy_issue():
    """–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø–æ–¥—Å—á–µ—Ç–∞ –∑–∞–∫–∞–∑–æ–≤."""
    logger.info("üîç DIAGNOSING: Orders counting accuracy")
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –∏–∑–≤–µ—Å—Ç–Ω–æ–π –ø—Ä–æ–±–ª–µ–º–æ–π
    test_nm_id = 12345678  # –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π nmId
    test_warehouse = "–ß–µ—Ö–æ–≤ 1"
    
    # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ API –≤—ã–∑–æ–≤—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    print(f"üìä Testing orders accuracy for nmId: {test_nm_id}")
    print(f"üì¶ Focus warehouse: {test_warehouse}")
    print("   ‚ö†Ô∏è Replace with real API data for actual testing")

async def diagnose_warehouse_name_mapping():
    """–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π —Å–∫–ª–∞–¥–æ–≤."""
    logger.info("üîç DIAGNOSING: Warehouse name mapping")
    
    # –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π
    wb_names = ["–ù–æ–≤–æ—Å–µ–º–µ–π–∫–∏–Ω–æ", "–ß–µ—Ö–æ–≤", "–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å"]
    st_names = ["–°–∞–º–∞—Ä–∞ (–ù–æ–≤–æ—Å–µ–º–µ–π–∫–∏–Ω–æ)", "–ß–µ—Ö–æ–≤ 1", "–°–∫–ª–∞–¥ –ø—Ä–æ–¥–∞–≤—Ü–∞"]
    
    validation = validate_warehouse_mapping(wb_names, st_names)
    
    print("üó∫Ô∏è Warehouse name mapping validation:")
    print(f"   Accuracy: {validation['accuracy_percent']:.1f}%")
    print(f"   Matched: {validation['matched_warehouses']}")
    print(f"   WB only: {validation['wb_only_warehouses']}")
    print(f"   ST only: {validation['st_only_warehouses']}")

async def main():
    """–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫."""
    setup_logging()
    
    print("üö® CRITICAL ISSUES DIAGNOSIS")
    print("=" * 50)
    
    await diagnose_marketplace_warehouse_issue()
    print()
    
    await diagnose_orders_accuracy_issue()
    print()
    
    await diagnose_warehouse_name_mapping()
    print()
    
    print("‚úÖ Diagnosis completed")

if __name__ == "__main__":
    asyncio.run(main())
```

## üìã –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### –§–ê–ó–ê 1: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø (24-48 —á–∞—Å–æ–≤)

1. **‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `is_real_warehouse()`**
   - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∏—Ç—å —Å–∫–ª–∞–¥ "–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å"
   - –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ FBS –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
   - –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

2. **‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å `group_data_by_product()`**
   - –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É `warehouseType`
   - –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è FBS —Å–∫–ª–∞–¥–æ–≤
   - –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø–æ–¥—Å—á–µ—Ç–æ–≤

3. **‚úÖ –°–æ–∑–¥–∞—Ç—å `warehouse_mapper.py`**
   - –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –Ω–∞–∑–≤–∞–Ω–∏–π
   - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Ñ–∞—Å–µ—Ç–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º

### –§–ê–ó–ê 2: –í–ê–õ–ò–î–ê–¶–ò–Ø –ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï (48-72 —á–∞—Å–∞)

1. **‚úÖ –°–æ–∑–¥–∞—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —É—Ç–∏–ª–∏—Ç—ã**
   - `diagnose_critical_issues.py`
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
   - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –¥–∞–Ω–Ω—ã–º–∏ WB

2. **‚úÖ –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - –ê—Ä—Ç–∏–∫—É–ª Its1_2_3/50g –∏ —Å–∫–ª–∞–¥ "–ß–µ—Ö–æ–≤ 1"
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–ª–∞–¥–∞ "–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å"
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π —Å–∫–ª–∞–¥–æ–≤

### –§–ê–ó–ê 3: –ú–û–ù–ò–¢–û–†–ò–ù–ì –ò –ü–û–î–î–ï–†–ñ–ö–ê (72+ —á–∞—Å–∞)

1. **‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–æ—á–Ω–æ—Å—Ç–∏**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π
   - –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö
   - –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –æ—Ç—á–µ—Ç—ã —Ç–æ—á–Ω–æ—Å—Ç–∏

2. **‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –æ–±—É—á–µ–Ω–∏–µ**
   - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
   - Troubleshooting guide
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

## üéØ –ö–†–ò–¢–ï–†–ò–ò –£–°–ü–ï–•–ê

### ‚úÖ –ö–†–ò–¢–ï–†–ò–ô 1: –°–∫–ª–∞–¥ "–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å" —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è
- –í—Å–µ FBS —Ç–æ–≤–∞—Ä—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏
- –°–∫–ª–∞–¥ "–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å" –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ
- –ó–∞–∫–∞–∑—ã —Å FBS —Å–∫–ª–∞–¥–æ–≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–¥—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è

### ‚úÖ –ö–†–ò–¢–ï–†–ò–ô 2: –¢–æ—á–Ω–æ—Å—Ç—å –ø–æ–¥—Å—á–µ—Ç–∞ –∑–∞–∫–∞–∑–æ–≤
- –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –¥–ª—è –∞—Ä—Ç–∏–∫—É–ª–∞ Its1_2_3/50g —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ
- –°–∫–ª–∞–¥ "–ß–µ—Ö–æ–≤ 1" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 5 –∑–∞–∫–∞–∑–æ–≤ (–∫–∞–∫ –≤ WB)
- –û–±—â–∏–µ –∏—Ç–æ–≥–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ WB

### ‚úÖ –ö–†–ò–¢–ï–†–ò–ô 3: –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
- "–ù–æ–≤–æ—Å–µ–º–µ–π–∫–∏–Ω–æ" –∏ "–°–∞–º–∞—Ä–∞ (–ù–æ–≤–æ—Å–µ–º–µ–π–∫–∏–Ω–æ)" –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã
- –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π —Å–∫–ª–∞–¥–æ–≤
- –í—Å–µ —Å–∫–ª–∞–¥—ã –∏–º–µ—é—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è

### ‚úÖ –ö–†–ò–¢–ï–†–ò–ô 4: FBS —Ç–æ–≤–∞—Ä—ã —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –û—Å—Ç–∞—Ç–∫–∏ FBS —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è
- –°–∫–ª–∞–¥—ã –ø—Ä–æ–¥–∞–≤—Ü–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ
- –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è FBS —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –í–ê–ñ–ù–û–°–¢–¨

–≠—Ç–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´** –¥–ª—è —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ Stock Tracker, —Ç–∞–∫ –∫–∞–∫:

1. **–ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö**: –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞ "–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å" –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø–æ—Ç–µ—Ä–µ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–π —á–∞—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
2. **–ù–µ—Ç–æ—á–Ω–æ—Å—Ç—å —Ä–∞—Å—á–µ—Ç–æ–≤**: –û—à–∏–±–∫–∏ –≤ –ø–æ–¥—Å—á–µ—Ç–µ –∑–∞–∫–∞–∑–æ–≤ –¥–∏—Å–∫—Ä–µ–¥–∏—Ç–∏—Ä—É—é—Ç –≤—Å—é —Å–∏—Å—Ç–µ–º—É
3. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ**: –†–∞–∑–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Å–∫–ª–∞–¥–æ–≤ —Å–æ–∑–¥–∞—é—Ç –ø—É—Ç–∞–Ω–∏—Ü—É –∏ –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏
4. **FBS —Ç–æ–≤–∞—Ä—ã**: –ù–µ—É—á–µ—Ç FBS –æ—Å—Ç–∞—Ç–∫–æ–≤ –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è –º–Ω–æ–≥–∏—Ö –ø—Ä–æ–¥–∞–≤—Ü–æ–≤

**–ë–ï–ó –≠–¢–ò–• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô STOCK TRACKER –ù–ï –ú–û–ñ–ï–¢ –°–ß–ò–¢–ê–¢–¨–°–Ø –ù–ê–î–ï–ñ–ù–´–ú –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–ú.**

---

**–°—Ç–∞—Ç—É—Å**: üö® **–¢–†–ï–ë–£–ï–¢ –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ô –†–ï–ê–õ–ò–ó–ê–¶–ò–ò**  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô**  
**–î–µ–¥–ª–∞–π–Ω**: **48 —á–∞—Å–æ–≤**  
**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π**: **Development Team**  

**–í–ù–ò–ú–ê–ù–ò–ï**: –î–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –∏ —Ç–æ—á–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö.