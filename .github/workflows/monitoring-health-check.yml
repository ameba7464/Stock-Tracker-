name: Monitoring Health Check

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  health-check:
    name: Check Monitoring System Health
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Prometheus
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.VM_HOST }}:9090/-/healthy)
          if [ "$STATUS" != "200" ]; then
            echo "‚ùå Prometheus is DOWN (HTTP $STATUS)"
            exit 1
          fi
          echo "‚úÖ Prometheus is UP"

      - name: Check Alertmanager
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.VM_HOST }}:9093/-/healthy)
          if [ "$STATUS" != "200" ]; then
            echo "‚ùå Alertmanager is DOWN (HTTP $STATUS)"
            exit 1
          fi
          echo "‚úÖ Alertmanager is UP"

      - name: Check Grafana
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.VM_HOST }}:3000/api/health)
          if [ "$STATUS" != "200" ]; then
            echo "‚ùå Grafana is DOWN (HTTP $STATUS)"
            exit 1
          fi
          echo "‚úÖ Grafana is UP"

      - name: Check API metrics endpoint
        run: |
          METRICS=$(curl -s http://${{ secrets.VM_HOST }}:8000/metrics | grep -c "^http_requests_total")
          if [ "$METRICS" -lt 1 ]; then
            echo "‚ùå API metrics endpoint not working"
            exit 1
          fi
          echo "‚úÖ API metrics endpoint is UP ($METRICS metrics found)"

      - name: Check Prometheus targets
        run: |
          TARGETS=$(curl -s http://${{ secrets.VM_HOST }}:9090/api/v1/targets | jq '.data.activeTargets | length')
          UP_TARGETS=$(curl -s http://${{ secrets.VM_HOST }}:9090/api/v1/targets | jq '.data.activeTargets | map(select(.health == "up")) | length')
          
          echo "Total targets: $TARGETS"
          echo "UP targets: $UP_TARGETS"
          
          if [ "$UP_TARGETS" -lt 5 ]; then
            echo "‚ùå Too many targets are DOWN"
            exit 1
          fi
          echo "‚úÖ Most Prometheus targets are UP"

      - name: Send health check notification
        if: failure()
        run: |
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_ALERT_CHAT_ID }}" \
            -d "text=üö® <b>MONITORING HEALTH CHECK FAILED</b>
          
          One or more monitoring services are not responding.
          Check the logs and restart services if needed.
          
          Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          Workflow: ${{ github.workflow }}
          " \
            -d "parse_mode=HTML"
