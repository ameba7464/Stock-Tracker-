name: Deploy Monitoring to Production

on:
  push:
    branches:
      - main
    paths:
      - 'monitoring/**'
      - 'docker-compose.yml'
      - 'src/stock_tracker/monitoring.py'
      - '.github/workflows/deploy-monitoring.yml'
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  deploy-monitoring:
    name: Deploy Monitoring System
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create monitoring secrets
        run: |
          mkdir -p monitoring/secrets
          echo "${{ secrets.TELEGRAM_BOT_TOKEN }}" > monitoring/secrets/telegram_bot_token.txt
          chmod 600 monitoring/secrets/telegram_bot_token.txt

      - name: Validate Prometheus config
        run: |
          docker run --rm -v $(pwd)/monitoring/prometheus.yml:/prometheus.yml prom/prometheus:v2.48.0 \
            promtool check config /prometheus.yml

      - name: Validate Alertmanager config
        run: |
          docker run --rm \
            -v $(pwd)/monitoring/alertmanager.yml:/alertmanager.yml \
            -v $(pwd)/monitoring/secrets/telegram_bot_token.txt:/run/secrets/telegram_bot_token:ro \
            prom/alertmanager:v0.26.0 \
            amtool check-config /alertmanager.yml

      - name: Configuration validation complete
        run: |
          echo "‚úÖ All monitoring configurations are valid"
          echo "üìã Validated:"
          echo "  - Prometheus config"
          echo "  - Alertmanager config"
          echo ""
          echo "‚ÑπÔ∏è Manual deployment required:"
          echo "  Run: docker-compose up -d --force-recreate prometheus grafana alertmanager"

      # Deployment disabled - manual deployment required
      # Uncomment and configure secrets (VM_HOST, VM_USER, VM_SSH_KEY) to enable
      # - name: Deploy to server via SSH
      #   if: github.ref == 'refs/heads/main'
      #   uses: appleboy/ssh-action@v1.0.0
      #   with:
      #     host: ${{ secrets.VM_HOST }}
      #     username: ${{ secrets.VM_USER }}
      #     key: ${{ secrets.VM_SSH_KEY }}
      #     port: ${{ secrets.SSH_PORT || 22 }}
      #     script: |
      #       cd /root/Stock-Tracker
      #       git pull origin main
      #       mkdir -p monitoring/secrets
      #       echo "${{ secrets.TELEGRAM_BOT_TOKEN }}" > monitoring/secrets/telegram_bot_token.txt
      #       chmod 600 monitoring/secrets/telegram_bot_token.txt
      #       docker-compose pull prometheus grafana alertmanager
      #       docker-compose up -d --force-recreate prometheus grafana alertmanager
      #       sleep 10
      #       curl -f http://localhost:9090/-/healthy || exit 1
      #       curl -f http://localhost:9093/-/healthy || exit 1
      #       curl -f http://localhost:3000/api/health || exit 1

      - name: Send deployment notification
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" == "success" ]; then
            EMOJI="‚úÖ"
            MESSAGE="Monitoring validation SUCCESSFUL"
          else
            EMOJI="‚ùå"
            MESSAGE="Monitoring validation FAILED"
          fi
          
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_ALERT_CHAT_ID }}" \
            -d "text=$EMOJI $MESSAGE
          
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          Workflow: ${{ github.workflow }}
          Status: Configuration validation only (manual deployment required)
          " \
            -d "parse_mode=HTML"
