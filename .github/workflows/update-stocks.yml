name: Update Stock Tracker Daily

on:
  schedule:
    # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:01 –ú–°–ö (21:01 UTC –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–Ω—è)
    - cron: '1 21 * * *'
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ GitHub UI
  push:
    branches:
      - main
    paths:
      - '.github/workflows/update-stocks.yml'

jobs:
  update-stocks:
    runs-on: ubuntu-latest
    permissions:
      contents: write # –ù—É–∂–Ω–æ –¥–ª—è –∫–æ–º–º–∏—Ç–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –≤ –±—É–¥—É—â–µ–º
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
    
    - name: üêç Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip' # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
    
    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: üìù Create service account file
      run: |
        mkdir -p config
        echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT }}' > config/service-account.json
    
    - name: üöÄ Run stock update
      env:
        WILDBERRIES_API_KEY: ${{ secrets.WILDBERRIES_API_KEY }}
        GOOGLE_SERVICE_ACCOUNT_KEY_PATH: ./config/service-account.json
        GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
        GOOGLE_SHEET_NAME: ${{ secrets.GOOGLE_SHEET_NAME }}
        LOG_LEVEL: INFO
        TZ: Europe/Moscow
      run: |
        python update_table_fixed.py
    
    - name: üßπ Cleanup sensitive data
      if: always()
      run: |
        rm -f config/service-account.json
    
    - name: ‚úÖ Success notification
      if: success()
      run: |
        echo "‚úÖ Stock tracker updated successfully at $(TZ=Europe/Moscow date +'%Y-%m-%d %H:%M:%S %Z')"
    
    - name: ‚ùå Failure notification
      if: failure()
      run: |
        echo "‚ùå Stock tracker update failed at $(TZ=Europe/Moscow date +'%Y-%m-%d %H:%M:%S %Z')"
        echo "Check the logs above for details"
