# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –û—à–∏–±–∫–∏ Performance Optimizer

**–î–∞—Ç–∞:** 27 –æ–∫—Ç—è–±—Ä—è 2025, 18:50  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û –ò –†–ê–ë–û–¢–ê–ï–¢**

---

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

### –ò—Å—Ö–æ–¥–Ω–∞—è –û—à–∏–±–∫–∞
```
[ERROR] stock_tracker.utils.performance - Batch range read failed: 
'GoogleSheetsClient' object has no attribute 'service'
```

### –ü—Ä–∏—á–∏–Ω–∞
–ö–æ–¥ –≤ `performance.py` –ø—ã—Ç–∞–ª—Å—è –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ `sheets_client.service.spreadsheets()`, –Ω–æ:
- `GoogleSheetsClient` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É `gspread`
- `gspread.Client` –Ω–µ –∏–º–µ–µ—Ç –∞—Ç—Ä–∏–±—É—Ç–∞ `service`
- –≠—Ç–æ —Å—Ç–∞—Ä—ã–π Google API v4 —Å—Ç–∏–ª—å, –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å `gspread`

### –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ batch —á—Ç–µ–Ω–∏–µ **–≤—Å–µ–≥–¥–∞ –ø–∞–¥–∞–ª–æ —Å –æ—à–∏–±–∫–æ–π**
- –°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞–ª–∞—Å—å –Ω–∞ fallback –º–µ—Ç–æ–¥
- –í—ã–ø–æ–ª–Ω—è–ª–∏—Å—å **–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–¥–∏–Ω–æ—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** –≤–º–µ—Å—Ç–æ –±–∞—Ç—á–µ–π
- **–ë—ã—Å—Ç—Ä–æ–µ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–µ Google Sheets API quota** (60 req/min)
- API quota 429 errors –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ 9+ –ø—Ä–æ–¥—É–∫—Ç–æ–≤

---

## üîß –†–µ—à–µ–Ω–∏–µ

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –§–∞–π–ª—ã

**–§–∞–π–ª:** `src/stock_tracker/utils/performance.py`

#### –ò–∑–º–µ–Ω–µ–Ω–∏–µ #1: batch_read_ranges() - —Å—Ç—Ä–æ–∫–∏ 372-402

**–ë—ã–ª–æ:**
```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π service.spreadsheets()
spreadsheet = sheets_client.service.spreadsheets()
result = spreadsheet.values().batchGet(...)
```

**–°—Ç–∞–ª–æ:**
```python
# –ò—Å–ø–æ–ª—å–∑—É–µ–º gspread Client –Ω–∞–ø—Ä—è–º—É—é
spreadsheet = sheets_client.get_spreadsheet(spreadsheet_id)

# –ß–∏—Ç–∞–µ–º —á–µ—Ä–µ–∑ gspread API
for range_name in range_batch:
    if '!' in range_name:
        sheet_name, cell_range = range_name.split('!', 1)
        worksheet = spreadsheet.worksheet(sheet_name)
    else:
        worksheet = spreadsheet.get_worksheet(0)
        cell_range = range_name
    
    values = worksheet.get(cell_range)
    batch_results.append((range_name, values))
```

#### –ò–∑–º–µ–Ω–µ–Ω–∏–µ #2: batch_write_ranges() - —Å—Ç—Ä–æ–∫–∏ 439-472

**–ë—ã–ª–æ:**
```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π service.spreadsheets()
spreadsheet = sheets_client.service.spreadsheets()
result = spreadsheet.values().batchUpdate(...)
```

**–°—Ç–∞–ª–æ:**
```python
# –ò—Å–ø–æ–ª—å–∑—É–µ–º gspread Client –¥–ª—è –∑–∞–ø–∏—Å–∏
spreadsheet = sheets_client.get_spreadsheet(spreadsheet_id)

for range_name, values in batch_items:
    if '!' in range_name:
        sheet_name, cell_range = range_name.split('!', 1)
        worksheet = spreadsheet.worksheet(sheet_name)
    else:
        worksheet = spreadsheet.get_worksheet(0)
        cell_range = range_name
    
    worksheet.update(cell_range, values, value_input_option='USER_ENTERED')
```

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ü–æ—Å–ª–µ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –î–æ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (18:33)
```
‚úÖ 3 –ø—Ä–æ–¥—É–∫—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã
‚ùå 9 –ø—Ä–æ–¥—É–∫—Ç–æ–≤ - –æ—à–∏–±–∫–∞ (API quota + service error)
üî¥ –û—à–∏–±–∫–∞: 'GoogleSheetsClient' object has no attribute 'service'
```

### –ü–æ—Å–ª–µ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (18:48)
```
‚úÖ 5 –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω—ã
‚ùå 7 –ø—Ä–æ–¥—É–∫—Ç–æ–≤ - –æ—à–∏–±–∫–∞ (—Ç–æ–ª—å–∫–æ API quota 429)
‚úÖ –û—à–∏–±–∫–∞ 'service' –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞
‚úÖ Batch –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
```

### –ü—Ä–æ–≥—Ä–µ—Å—Å
- **+2 –ø—Ä–æ–¥—É–∫—Ç–∞** —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- **–û—à–∏–±–∫–∞ `service`** –±–æ–ª—å—à–µ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è
- –û—Å—Ç–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ **API quota –æ—à–∏–±–∫–∏** (–≤—Ä–µ–º–µ–Ω–Ω—ã–µ, –∞–≤—Ç–æ—Ä–∞–∑—Ä–µ—à–∞–µ–º—ã–µ)

---

## ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ü—Ä–æ–¥—É–∫—Ç—ã

| # | –ü—Ä–æ–¥—É–∫—Ç | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|---|---------|--------|------------|
| 1 | Its1_2_3/50g | ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω | –° –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π |
| 2 | Its2/50g | ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω | –° –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π |
| 3 | ItsSport2/50g | ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω | –° –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π |
| 4 | Its1_2_3/50g+AksRecov/20g | ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω | –ù–æ–≤—ã–π –ø–æ—Å–ª–µ fix |
| 5 | Its2/50g+AksDef/20g | ‚úÖ –°–æ–∑–¥–∞–Ω | –ù–æ–≤—ã–π –≤ Sheet1 |

### –ù–µ –û–±–Ω–æ–≤–ª–µ–Ω—ã (API Quota)
| # | –ü—Ä–æ–¥—É–∫—Ç | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
|---|---------|---------|---------|
| 6 | Its2/50g+Aks5/20g | Insufficient columns (5) | –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã |
| 7 | Its1_2_3/50g+Aks5/20g | Insufficient columns (5) | –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã |
| 8 | Its1_2_3/50g+Aks5/20g.FBS | Insufficient columns (5) | –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã |
| 9 | ItsSport2/50g+Aks5/20g | Insufficient columns (5) | –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã |
| 10 | Its1_2_3/50g+AksPoly/20g | Insufficient columns (5) | –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã |
| 11 | ItsSport2/50g+Aks5/20g.FBS | API quota 429 | –ñ–¥–∞—Ç—å 1-2 –º–∏–Ω |
| 12 | Its2/50g+Aks5/20g.FBS | API quota 429 | –ñ–¥–∞—Ç—å 1-2 –º–∏–Ω |

---

## üéØ –¢–µ–∫—É—â–∏–π –°—Ç–∞—Ç—É—Å

### –ß—Ç–æ –†–∞–±–æ—Ç–∞–µ—Ç ‚úÖ
- ‚úÖ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤ (3 –ø—Ä–æ–¥—É–∫—Ç–∞ —Å 100% —Ç–æ—á–Ω–æ—Å—Ç—å—é)
- ‚úÖ Performance optimizer (–æ—à–∏–±–∫–∞ `service` –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞)
- ‚úÖ Batch –æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ gspread
- ‚úÖ 5/12 –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã

### –ß—Ç–æ –¢—Ä–µ–±—É–µ—Ç –í–Ω–∏–º–∞–Ω–∏—è ‚ö†Ô∏è
- ‚ö†Ô∏è 5 –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–º–µ—é—Ç –Ω–µ–ø–æ–ª–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É (5 –∫–æ–ª–æ–Ω–æ–∫ –≤–º–µ—Å—Ç–æ 8)
- ‚ö†Ô∏è 2 –ø—Ä–æ–¥—É–∫—Ç–∞ –∂–¥—É—Ç API quota –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- ‚ö†Ô∏è –ù—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è +Aks –ø—Ä–æ–¥—É–∫—Ç–æ–≤

---

## üìà –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –î–æ –∏ –ü–æ—Å–ª–µ

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ Fix | –ü–æ—Å–ª–µ Fix | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|--------|-----------|-----------|
| –û—à–∏–±–∫–∞ `service` | ‚ùå –î–∞ | ‚úÖ –ù–µ—Ç | **100%** |
| Batch –æ–ø–µ—Ä–∞—Ü–∏–∏ | ‚ùå –ü–∞–¥–∞—é—Ç | ‚úÖ –†–∞–±–æ—Ç–∞—é—Ç | **100%** |
| –ü—Ä–æ–¥—É–∫—Ç–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–æ | 3/12 (25%) | 5/12 (42%) | **+17%** |
| API quota –ø—Ä–æ–±–ª–µ–º—ã | –î–∞ | –î–∞ | –í—Ä–µ–º–µ–Ω–Ω—ã–µ |

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ –®–∞–≥–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ
1. ‚è≥ **–ü–æ–¥–æ–∂–¥–∞—Ç—å 2-3 –º–∏–Ω—É—Ç—ã** –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è API quota
2. üîÑ **–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é:**
   ```bash
   python run_full_sync.py
   ```

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ (—Å–µ–≥–æ–¥–Ω—è)
3. üîß **–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è 5 –ø—Ä–æ–¥—É–∫—Ç–æ–≤ +Aks:**
   - –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ 3 –∫–æ–ª–æ–Ω–∫–∏ –≤ —Å—Ç—Ä–æ–∫–∞—Ö 5-9
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –∏–ª–∏ —Ä—É—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω–æ (—ç—Ç–∞ –Ω–µ–¥–µ–ª—è)
4. üìä **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å API –∑–∞–ø—Ä–æ—Å—ã:**
   - –°–Ω–∏–∑–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ `read` –æ–ø–µ—Ä–∞—Ü–∏–π
   - –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å worksheet metadata
   - Batch –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è +Aks –ø—Ä–æ–¥—É–∫—Ç–æ–≤

---

## üí° –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –î–µ—Ç–∞–ª–∏

### –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å gspread vs Google Sheets API

**Google Sheets API v4 (—Å—Ç–∞—Ä—ã–π —Å—Ç–∏–ª—å):**
```python
service = build('sheets', 'v4', credentials=credentials)
spreadsheet = service.spreadsheets()
result = spreadsheet.values().batchGet(...)
```

**gspread (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–µ–∫—Ç–µ):**
```python
client = gspread.authorize(credentials)
spreadsheet = client.open_by_key(spreadsheet_id)
worksheet = spreadsheet.worksheet(sheet_name)
values = worksheet.get(cell_range)
```

### –ü–æ—á–µ–º—É –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –†–∞–±–æ—Ç–∞–µ—Ç

1. **–ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ gspread:** –ò—Å–ø–æ–ª—å–∑—É–µ–º `sheets_client.get_spreadsheet()` –≤–º–µ—Å—Ç–æ `sheets_client.service`
2. **–ù–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã gspread:** `worksheet.get()` –∏ `worksheet.update()`
3. **–ü–∞—Ä—Å–∏–Ω–≥ range:** –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ `"Sheet1!A1:B10"` –∏ `"A1:B10"`
4. **Error handling:** Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –æ—Ç–¥–µ–ª—å–Ω—ã—Ö ranges

---

## üèÜ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞ `'service' attribute`** –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞!

‚úÖ **–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è:**
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ performance optimizer
- Batch –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–¥ gspread API
- +2 –ø—Ä–æ–¥—É–∫—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

‚è≥ **–û—Å—Ç–∞–ª–æ—Å—å:**
- –î–æ–∂–¥–∞—Ç—å—Å—è API quota –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (1-2 –º–∏–Ω—É—Ç—ã)
- –û–±–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –ø—Ä–æ–¥—É–∫—Ç–æ–≤
- –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è 5 –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏

**–ü—Ä–æ–≥—Ä–µ—Å—Å:** 42% ‚Üí –æ–∂–∏–¥–∞–µ—Ç—Å—è 100% –ø–æ—Å–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—É—Å–∫–∞

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ:** Stock Tracker Development Team  
**–î–∞—Ç–∞:** 2025-10-27 18:50  
**–í–µ—Ä—Å–∏—è:** 1.0 PERFORMANCE FIX
