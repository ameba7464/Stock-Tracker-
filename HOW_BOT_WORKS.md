# ĞšĞ°Ğº Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Telegram Ğ‘Ğ¾Ñ‚ ĞŸĞ¾ÑĞ»Ğµ Ğ£Ğ½Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸

**Ğ”Ğ°Ñ‚Ğ°:** 25 Ğ´ĞµĞºĞ°Ğ±Ñ€Ñ 2025 Ğ³.  
**Ğ’ĞµÑ€ÑĞ¸Ñ:** 2.0 (Unified Subscriptions)

---

## ğŸ¯ ĞĞ±Ñ‰Ğ°Ñ ĞšĞ¾Ğ½Ñ†ĞµĞ¿Ñ†Ğ¸Ñ

Ğ‘Ğ¾Ñ‚ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ **ÑƒĞ½Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½ÑƒÑ ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¾Ğº** Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹ **feature flag** Ğ´Ğ»Ñ Ğ»ĞµĞ³ĞºĞ¾Ğ³Ğ¾ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ¾Ñ‚ Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾Ğ¹ Ğº Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾Ğ¹ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸.

### ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ñ‹

1. **Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ¿Ñ€Ğ°Ğ²Ğ´Ñ‹** â€” Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° `subscriptions` ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ğ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿
2. **Feature Flag** â€” `payment_enabled` Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ Ñ€ĞµĞ¶Ğ¸Ğ¼Ñ‹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹
3. **ĞĞ±Ñ€Ğ°Ñ‚Ğ½Ğ°Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ** â€” ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ½Ğµ Ñ‚ĞµÑ€ÑÑÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿
4. **Fail-open** â€” Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ… Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ (Ğ»ÑƒÑ‡ÑˆĞµ Ğ´Ğ»Ñ UX)

---

## ğŸ“Š ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ°

### ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ”Ğ°Ğ½Ğ½Ñ‹Ñ…

```python
# Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° users (Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ)
User:
  - id (UUID)
  - telegram_id (BigInt, unique)
  - full_name, email, phone
  - wb_api_key (Wildberries API)
  - google_sheet_id
  - payment_status (DEPRECATED - Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾Ğ¹ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸)

# Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° subscriptions (ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ¿Ñ€Ğ°Ğ²Ğ´Ñ‹)
Subscription:
  - id (UUID)
  - user_id (UUID, FK â†’ users.id)
  
  # ĞšĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
  - status ('FREE' | 'TRIAL' | 'PAID' | 'EXPIRED')
  - has_access (Boolean) â† Ğ“Ğ›ĞĞ’ĞĞĞ• ĞŸĞĞ›Ğ•!
  
  # Ğ”Ğ°Ñ‚Ñ‹ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ
  - trial_ends_at (Ğ´Ğ»Ñ Ñ‚Ñ€Ğ¸Ğ°Ğ»Ğ¾Ğ²)
  - subscription_starts_at
  - subscription_ends_at (Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¾Ğº)
  
  # ĞœĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ĞµĞ¹
  - payment_provider ('yookassa' | 'stripe' | etc)
  - payment_external_id (ID Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸)
  - last_payment_at
```

---

## ğŸ”„ Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¸ Ğ Ğ°Ğ±Ğ¾Ñ‚Ñ‹

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ 1: ĞĞ¾Ğ²Ñ‹Ğ¹ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ (MVP Ğ ĞµĞ¶Ğ¸Ğ¼)

**Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ğµ:** `payment_enabled = False` (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ)

```
1. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ /start
   â†“
2. Ğ‘Ğ¾Ñ‚ Ğ½Ğµ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ user Ğ² Ğ‘Ğ” â†’ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ
   â†“
3. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ğ²Ğ¾Ğ´Ğ¸Ñ‚:
   - Ğ˜Ğ¼Ñ: "Ğ˜Ğ²Ğ°Ğ½ Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²"
   - Email: "ivan@example.com"
   - Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½: "+79991234567"
   â†“
4. Ğ‘Ğ¾Ñ‚ ÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚:
   a) User Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ users
   b) Subscription Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ subscriptions:
      - status = 'FREE'
      - has_access = TRUE
      - subscription_starts_at = NOW()
   â†“
5. Ğ‘Ğ¾Ñ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° Google Sheet
   â†“
6. ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ
```

**ĞšĞ¾Ğ´:**
```python
# registration.py
subscription = await get_or_create_subscription(user.id, session)
# â†’ Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ FREE Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ, Ñ‚Ğ°Ğº ĞºĞ°Ğº payment_enabled=False

await send_google_sheet(message, session, user, name)
```

---

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ 2: Ğ¡ÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ (MVP Ğ ĞµĞ¶Ğ¸Ğ¼)

**Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ğµ:** `payment_enabled = False`

```
1. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ /start
   â†“
2. Ğ‘Ğ¾Ñ‚ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ user Ğ² Ğ‘Ğ”
   â†“
3. Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ check_user_access(user.id, session)
   â†’ payment_enabled = False
   â†’ return True (Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğ´Ğ»Ñ Ğ²ÑĞµÑ…)
   â†“
4. ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ
```

**ĞšĞ¾Ğ´:**
```python
# start.py
if user:
    has_access = await check_user_access(user.id, session)
    if has_access:
        # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¼ĞµĞ½Ñ
```

---

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ 3: ĞĞ¾Ğ²Ñ‹Ğ¹ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ (ĞŸÑ€Ğ¾Ğ´Ğ°ĞºÑˆĞ½ Ñ Ğ¢Ñ€Ğ¸Ğ°Ğ»Ğ¾Ğ¼)

**Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ğµ:** `payment_enabled = True`, `free_trial_days = 7`

```
1. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ /start
   â†“
2. ĞŸÑ€Ğ¾Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ (Ğ¸Ğ¼Ñ, email, Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½)
   â†“
3. Ğ‘Ğ¾Ñ‚ ÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚:
   a) User
   b) Subscription:
      - status = 'TRIAL'
      - has_access = TRUE
      - trial_ends_at = NOW() + 7 Ğ´Ğ½ĞµĞ¹
   â†“
4. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ:
   "âœ… Ğ£ Ğ²Ğ°Ñ 7 Ğ´Ğ½ĞµĞ¹ Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°!
    ĞŸĞ¾ÑĞ»Ğµ Ñ‚Ñ€Ğ¸Ğ°Ğ»Ğ°: 299â‚½/Ğ¼ĞµÑ"
   â†“
5. ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ
```

**ĞšĞ¾Ğ´:**
```python
# subscription.py â†’ get_or_create_subscription()
if settings.payment_enabled:
    subscription = Subscription(
        user_id=user_id,
        status='TRIAL',
        has_access=True,
        trial_ends_at=datetime.utcnow() + timedelta(days=7)
    )
```

---

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ 4: Ğ˜ÑÑ‚ĞµĞº Ğ¢Ñ€Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞŸĞµÑ€Ğ¸Ğ¾Ğ´

**Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ğµ:** `payment_enabled = True`, Ñ‚Ñ€Ğ¸Ğ°Ğ» Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»ÑÑ

```
1. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ /start
   â†“
2. Ğ‘Ğ¾Ñ‚ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ user
   â†“
3. check_user_access(user.id, session):
   a) ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ subscription
   b) ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚: trial_ends_at < NOW()
   c) ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚:
      - status = 'EXPIRED'
      - has_access = FALSE
   d) return False
   â†“
4. Ğ‘Ğ¾Ñ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚:
   "â° Ğ’Ğ°Ñˆ Ñ‚Ñ€Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ Ğ¸ÑÑ‚ĞµĞº.
    Ğ”Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½Ğ¸Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ: /subscribe"
   â†“
5. ĞĞµ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¼ĞµĞ½Ñ
```

**ĞšĞ¾Ğ´:**
```python
# subscription.py â†’ check_user_access()
if subscription.status == 'TRIAL' and subscription.trial_ends_at:
    if datetime.utcnow() > subscription.trial_ends_at:
        subscription.status = 'EXPIRED'
        subscription.has_access = False
        await session.commit()
        return False
```

---

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ 5: ĞĞ¿Ğ»Ğ°Ñ‚Ğ° ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸

**Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ğµ:** ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¶Ğ°Ğ» /subscribe Ğ¸Ğ»Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ "ĞÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚ÑŒ"

```
1. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ğ¸Ğ´Ğ¸Ñ‚:
   "ğŸ’³ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°: 299â‚½/Ğ¼ĞµÑ
    Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ¿Ğ¾ÑĞ¾Ğ± Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹:"
   [YooKassa] [Ğ‘Ğ°Ğ½ĞºĞ¾Ğ²ÑĞºĞ°Ñ ĞºĞ°Ñ€Ñ‚Ğ°] [Ğ¡Ğ‘ĞŸ]
   â†“
2. Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ ÑĞ¿Ğ¾ÑĞ¾Ğ± Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹
   â†“
3. Ğ‘Ğ¾Ñ‚ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ invoice Ñ‡ĞµÑ€ĞµĞ· YooKassa API
   â†“
4. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ğ¿Ğ»Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚
   â†“
5. YooKassa Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ webhook â†’ /api/webhooks/yookassa
   â†“
6. Ğ‘Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹
   â†“
7. Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ grant_paid_access():
   - status = 'PAID'
   - has_access = TRUE
   - subscription_starts_at = NOW()
   - subscription_ends_at = NOW() + 30 Ğ´Ğ½ĞµĞ¹
   - payment_provider = 'yookassa'
   - payment_external_id = 'transaction_id'
   â†“
8. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ:
   "âœ… ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!
    ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ° Ğ´Ğ¾: 25.01.2026"
   â†“
9. ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ
```

**ĞšĞ¾Ğ´:**
```python
# subscription.py â†’ grant_paid_access()
subscription = await get_or_create_subscription(user_id, session)
subscription.status = 'PAID'
subscription.has_access = True
subscription.subscription_ends_at = now + timedelta(days=30)
await session.commit()
```

---

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ 6: Legacy ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ñ€Ğ¸ Ğ’ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¸ ĞŸĞ»Ğ°Ñ‚ĞµĞ¶ĞµĞ¹

**Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ğµ:** `payment_enabled` Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ¸Ğ»Ğ¸ Ñ False Ğ½Ğ° True

```
1. Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ (Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ´Ğ¾ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ĞµĞ¹)
   â†“
2. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ /start
   â†“
3. check_user_access():
   a) ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ subscription ÑĞ¾ status='FREE' Ğ¸ has_access=TRUE
   b) return TRUE (grandfathered access)
   â†“
4. ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¼ĞµĞ½Ñ ĞºĞ°Ğº Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾
   
ğŸ‘‰ Legacy users ĞĞ• Ñ‚ĞµÑ€ÑÑÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¿Ñ€Ğ¸ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ĞµĞ¹!
```

**Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñ‹:**
```python
# ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ ÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚ FREE Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… users:
INSERT INTO subscriptions (user_id, status, has_access)
SELECT id, 'FREE', TRUE
FROM users
WHERE telegram_id IS NOT NULL;
```

---

## ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ° (Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾)

### Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ check_user_access()

```python
async def check_user_access(user_id: UUID, session: AsyncSession) -> bool:
    # Ğ¨Ğ°Ğ³ 1: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° feature flag
    if not settings.payment_enabled:
        return True  # MVP Ñ€ĞµĞ¶Ğ¸Ğ¼ â†’ Ğ²ÑĞµ Ğ¸Ğ¼ĞµÑÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿
    
    # Ğ¨Ğ°Ğ³ 2: ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸
    subscription = await session.execute(
        select(Subscription).where(Subscription.user_id == user_id)
    ).scalar_one_or_none()
    
    # Ğ¨Ğ°Ğ³ 3: Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ğ½ĞµÑ‚ â†’ ÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼ FREE (legacy user)
    if not subscription:
        subscription = Subscription(
            user_id=user_id,
            status='FREE',
            has_access=True
        )
        session.add(subscription)
        await session.commit()
        return True
    
    # Ğ¨Ğ°Ğ³ 4: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‚Ñ€Ğ¸Ğ°Ğ»Ğ°
    if subscription.status == 'TRIAL':
        if subscription.trial_ends_at < datetime.utcnow():
            subscription.status = 'EXPIRED'
            subscription.has_access = False
            await session.commit()
            return False
    
    # Ğ¨Ğ°Ğ³ 5: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾Ğ¹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸
    if subscription.status == 'PAID':
        if subscription.subscription_ends_at < datetime.utcnow():
            subscription.status = 'EXPIRED'
            subscription.has_access = False
            await session.commit()
            return False
    
    # Ğ¨Ğ°Ğ³ 6: Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
    return subscription.has_access
```

---

## ğŸ›ï¸ Feature Flag Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ

### ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ ĞµĞ¶Ğ¸Ğ¼Ğ¾Ğ²

**MVP â†’ ĞŸÑ€Ğ¾Ğ´Ğ°ĞºÑˆĞ½ (Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ĞµĞ¹):**

```env
# Ğ‘Ñ‹Ğ»Ğ¾ Ğ² .env:
PAYMENT_ENABLED=false

# Ğ¡Ñ‚Ğ°Ğ»Ğ¾:
PAYMENT_ENABLED=true
PAYMENT_PROVIDER=yookassa
PAYMENT_TOKEN=live_token_here
FREE_TRIAL_DAYS=7
SUBSCRIPTION_PRICE=299
```

**ĞŸĞ¾ÑĞ»Ğµ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ±Ğ¾Ñ‚Ğ°:**
- Ğ¡ÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ â†’ status=FREE, Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ
- ĞĞ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ â†’ status=TRIAL, 7 Ğ´Ğ½ĞµĞ¹ Ñ‚Ñ€Ğ¸Ğ°Ğ»Ğ°
- ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ñ ÑÑ€Ğ¾ĞºĞ°

---

## ğŸ“± Ğ¥ĞµĞ½Ğ´Ğ»ĞµÑ€Ñ‹ Ğ‘Ğ¾Ñ‚Ğ°

### /start â€” Ğ¢Ğ¾Ñ‡ĞºĞ° Ğ’Ñ…Ğ¾Ğ´Ğ°

```python
@router.message(CommandStart())
async def cmd_start(message: Message, state: FSMContext, session: AsyncSession):
    user = await get_user_by_telegram_id(session, message.from_user.id)
    
    if user:
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ñ‡ĞµÑ€ĞµĞ· unified ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ
        has_access = await check_user_access(user.id, session)
        
        if has_access:
            await show_main_menu(message, user)
        else:
            await message.answer(
                "â° Ğ’Ğ°ÑˆĞ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ¸ÑÑ‚ĞµĞºĞ»Ğ°.\n"
                "Ğ”Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½Ğ¸Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹: /subscribe"
            )
    else:
        # ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ
        await state.set_state(RegistrationStates.GET_NAME)
        await message.answer("ĞšĞ°Ğº Ğ²Ğ°Ñ Ğ·Ğ¾Ğ²ÑƒÑ‚?")
```

---

### Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ â€” Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ User + Subscription

```python
async def complete_registration(...):
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    user, was_created = await get_or_create_user(...)
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ (ÑƒÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°Ñ feature flag)
    subscription = await get_or_create_subscription(user.id, session)
    
    # Ğ•ÑĞ»Ğ¸ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ¸ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ñ‹:
    if settings.payment_enabled:
        # TODO: ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ invoice
        # await send_payment_invoice(message, user, subscription)
        pass
    else:
        # MVP: ÑÑ€Ğ°Ğ·Ñƒ Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿
        await send_google_sheet(message, session, user, name)
```

---

### ĞœĞµĞ½Ñ â€” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ°

```python
@router.callback_query(F.data == "get_sheet")
async def callback_get_sheet(callback: CallbackQuery, session: AsyncSession):
    user = await get_user_by_telegram_id(session, callback.from_user.id)
    
    # Unified Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
    has_access = await check_user_access(user.id, session)
    
    if not has_access:
        await callback.answer(
            "âŒ Ğ”Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°: /subscribe",
            show_alert=True
        )
        return
    
    # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ
    await callback.message.answer(f"ğŸ“Š Ğ’Ğ°ÑˆĞ° Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°: {settings.google_sheet_url}")
```

---

## ğŸ› ï¸ Ğ¡ĞµÑ€Ğ²Ğ¸ÑĞ½Ñ‹Ğµ Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸

### get_or_create_subscription()

**ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ:** Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ feature flag

```python
subscription = await get_or_create_subscription(user_id, session)

# Ğ›Ğ¾Ğ³Ğ¸ĞºĞ°:
if settings.payment_enabled:
    # ĞĞ¾Ğ²Ñ‹Ğ¹ user â†’ TRIAL (7 Ğ´Ğ½ĞµĞ¹)
    status='TRIAL', has_access=True, trial_ends_at=NOW()+7d
else:
    # MVP Ñ€ĞµĞ¶Ğ¸Ğ¼ â†’ FREE
    status='FREE', has_access=True
```

---

### grant_paid_access()

**ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ:** Ğ’Ñ‹Ğ´Ğ°Ñ‡Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹

```python
await grant_paid_access(
    user_id=user.id,
    session=session,
    payment_provider='yookassa',
    payment_id='tx_12345',
    duration_days=30
)

# Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚:
# - status = 'PAID'
# - has_access = TRUE
# - subscription_ends_at = NOW() + 30 Ğ´Ğ½ĞµĞ¹
```

---

### revoke_access()

**ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ:** ĞÑ‚Ğ·Ñ‹Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° (Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°, Ğ½Ğ°Ñ€ÑƒÑˆĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»)

```python
await revoke_access(user_id, session)

# Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚:
# - status = 'EXPIRED'
# - has_access = FALSE
```

---

### get_subscription_info()

**ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ:** ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞµ Ğ´Ğ»Ñ UI

```python
info = await get_subscription_info(user_id, session)

# Ğ’ĞµÑ€Ğ½ĞµÑ‚:
{
    'status': 'PAID',
    'has_access': True,
    'days_remaining': 15,
    'is_trial': False,
    'is_paid': True,
    'subscription_ends_at': datetime(2026, 1, 25)
}
```

---

## ğŸ¨ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ğ¹ ĞĞ¿Ñ‹Ñ‚

### MVP Ğ ĞµĞ¶Ğ¸Ğ¼ (Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ)

```
ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ â†’ /start
    â†“
Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ (30 ÑĞµĞº)
    â†“
âœ… Ğ¡Ñ€Ğ°Ğ·Ñƒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ
    â†“
Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° Ğ±ĞµĞ· Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğ¹
```

---

### ĞŸÑ€Ğ¾Ğ´Ğ°ĞºÑˆĞ½ Ñ Ğ¢Ñ€Ğ¸Ğ°Ğ»Ğ¾Ğ¼ (Ğ‘ÑƒĞ´ÑƒÑ‰ĞµĞµ)

```
ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ â†’ /start
    â†“
Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ
    â†“
ğŸ "7 Ğ´Ğ½ĞµĞ¹ Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°!"
    â†“
Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° 7 Ğ´Ğ½ĞµĞ¹
    â†“
â° "Ğ¢Ñ€Ğ¸Ğ°Ğ» Ğ¸ÑÑ‚ĞµĞº. ĞÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ: 299â‚½/Ğ¼ĞµÑ"
    â†“
ĞĞ¿Ğ»Ğ°Ñ‚Ğ° â†’ âœ… Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ½Ğ° 30 Ğ´Ğ½ĞµĞ¹
```

---

## ğŸ“Š Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸

### FREE (Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ğ¹)

**ĞšĞ¾Ğ³Ğ´Ğ°:** 
- MVP Ñ€ĞµĞ¶Ğ¸Ğ¼ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ñ‹Ñ… users
- Legacy users Ğ¿Ñ€Ğ¸ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ĞµĞ¹

**ĞŸĞ¾Ğ»Ñ:**
```python
status = 'FREE'
has_access = True
subscription_starts_at = NOW()
subscription_ends_at = None  # Ğ‘ĞµÑÑÑ€Ğ¾Ñ‡Ğ½Ğ¾
```

---

### TRIAL (Ğ¢Ñ€Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹)

**ĞšĞ¾Ğ³Ğ´Ğ°:**
- ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ñ€Ğ¸ payment_enabled=True

**ĞŸĞ¾Ğ»Ñ:**
```python
status = 'TRIAL'
has_access = True
trial_ends_at = NOW() + 7 days
```

**ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ñ:**
```python
if NOW() > trial_ends_at:
    status = 'EXPIRED'
    has_access = False
```

---

### PAID (ĞĞ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¹)

**ĞšĞ¾Ğ³Ğ´Ğ°:**
- ĞŸĞ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ¹ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹

**ĞŸĞ¾Ğ»Ñ:**
```python
status = 'PAID'
has_access = True
subscription_starts_at = NOW()
subscription_ends_at = NOW() + 30 days
payment_provider = 'yookassa'
payment_external_id = 'tx_12345'
last_payment_at = NOW()
```

**ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ñ:**
```python
if NOW() > subscription_ends_at:
    status = 'EXPIRED'
    has_access = False
```

---

### EXPIRED (Ğ˜ÑÑ‚ĞµĞºÑˆĞ¸Ğ¹)

**ĞšĞ¾Ğ³Ğ´Ğ°:**
- Ğ¢Ñ€Ğ¸Ğ°Ğ» Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»ÑÑ Ğ±ĞµĞ· Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹
- ĞŸĞ»Ğ°Ñ‚Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»Ğ°ÑÑŒ Ğ±ĞµĞ· Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ¸Ñ

**ĞŸĞ¾Ğ»Ñ:**
```python
status = 'EXPIRED'
has_access = False
```

**Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:**
- Ğ—Ğ°Ğ¿Ñ€ĞµÑ‚Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ñ„ÑƒĞ½ĞºÑ†Ğ¸ÑĞ¼
- ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ /subscribe

---

## ğŸ” Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ

### Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Race Conditions

```python
# ĞŸÑ€Ğ¸ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ get_or_create_user():
existing_user = await get_user_by_telegram_id(session, telegram_id)
if existing_user:
    return existing_user, False  # ĞĞµ ÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚

# ĞŸÑ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸:
subscription = await session.execute(
    select(Subscription).where(Subscription.user_id == user_id)
).scalar_one_or_none()

if not subscription:
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚
```

---

### Fail-Open Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ

```python
try:
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿
    subscription = await get_subscription(...)
    return subscription.has_access
except Exception as e:
    logger.error(f"Error checking access: {e}")
    return True  # Ğ’ ÑĞ»ÑƒÑ‡Ğ°Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ (Ğ»ÑƒÑ‡ÑˆĞµ Ğ´Ğ»Ñ UX)
```

---

## ğŸ“ˆ ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³

### ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ

```python
# 1. Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
logger.info(f"New user registered: telegram_id={telegram_id}")

# 2. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¾Ğº
logger.info(f"Created {subscription.status} subscription for user {user_id}")

# 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
logger.debug(f"Access check: user={user_id}, result={has_access}")

# 4. ĞĞ¿Ğ»Ğ°Ñ‚Ñ‹
logger.info(f"Payment received: user={user_id}, amount=299, provider=yookassa")

# 5. Ğ˜ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¾Ğº
logger.info(f"Subscription expired: user={user_id}, status=TRIALâ†’EXPIRED")
```

---

## ğŸ¯ Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ Ğ¡Ñ…ĞµĞ¼Ğ° Ğ Ğ°Ğ±Ğ¾Ñ‚Ñ‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   /start     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User exists? â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”
   â”‚  YES  â”‚  NO
   â”‚       â”‚   â”‚
   â–¼       â–¼   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚check â”‚ â”‚Registrationâ”‚
â”‚accessâ”‚ â”‚   Flow     â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
   â”‚            â”‚
   â”‚            â–¼
   â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚      â”‚get_or_create_â”‚
   â”‚      â”‚subscription()â”‚
   â”‚      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
             â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚payment_enabled?â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
        â”‚         â”‚
     FALSE      TRUE
        â”‚         â”‚
        â–¼         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ FREE   â”‚ â”‚ TRIAL   â”‚
   â”‚access  â”‚ â”‚7 days   â”‚
   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚           â”‚
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
              â”‚
              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚has_accessâ”‚
        â”‚  = TRUE? â”‚
        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
              â”‚
         â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
         â”‚         â”‚
       TRUE      FALSE
         â”‚         â”‚
         â–¼         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Show  â”‚ â”‚  Show    â”‚
    â”‚  Menu  â”‚ â”‚/subscribeâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ° ĞĞ¾Ğ²Ğ¾Ğ¹ ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹

1. **Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ¿Ñ€Ğ°Ğ²Ğ´Ñ‹** â€” Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ²Ğ¾Ñ€ĞµÑ‡Ğ¸Ğ¹ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°Ğ¼Ğ¸
2. **Feature Flag** â€” Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞ¾Ğ¹ Ğ² .env
3. **ĞĞ±Ñ€Ğ°Ñ‚Ğ½Ğ°Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ** â€” legacy users Ğ·Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ñ‹
4. **ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ñ‚Ğ° Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ** â€” Ğ»ĞµĞ³ĞºĞ¾ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°Ñ‚ÑŒÑÑ Ğ¼ĞµĞ¶Ğ´Ñƒ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ°Ğ¼Ğ¸
5. **Ğ Ğ°ÑÑˆĞ¸Ñ€ÑĞµĞ¼Ğ¾ÑÑ‚ÑŒ** â€” Ğ»ĞµĞ³ĞºĞ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ñ‹/Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸
6. **Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ** â€” fail-open, Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ race conditions
7. **ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³** â€” Ğ²ÑĞµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒÑÑ‚ÑÑ

---

**Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¾:** 25 Ğ´ĞµĞºĞ°Ğ±Ñ€Ñ 2025 Ğ³.  
**Ğ’ĞµÑ€ÑĞ¸Ñ:** 2.0  
**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾ Ğº production
