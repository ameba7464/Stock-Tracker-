# üîç –û–¢–ß–Å–¢: –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ —Ä–µ—à–µ–Ω–∏–µ

**–î–∞—Ç–∞**: 28 –æ–∫—Ç—è–±—Ä—è 2025  
**–¢–æ–≤–∞—Ä**: Its1_2_3/50g (WB nmId: 163383326)  
**–ü—Ä–æ–±–ª–µ–º–∞**: –û—Å—Ç–∞—Ç–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ –ù–ï —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–º –Ω–∞ Wildberries

---

## üìä –°–ò–ú–ü–¢–û–ú–´

### –ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç Wildberries:
- **–û—Å—Ç–∞—Ç–∫–∏ (–≤—Å–µ–≥–æ)**: 3,459 —à—Ç
- **–ò–∑ –Ω–∏—Ö –ú–ü/FBS**: 2,984 —à—Ç
- **–û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–∞—Ö WB (FBO)**: ~475 —à—Ç

### –ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–∞–±–ª–∏—Ü–∞:
- **–û—Å—Ç–∞—Ç–∫–∏ (–≤—Å–µ–≥–æ)**: 475 —à—Ç ‚ùå –ù–ï–í–ï–†–ù–û
- **–°–∫–ª–∞–¥—ã**: –¢–æ–ª—å–∫–æ —Å–∫–ª–∞–¥—ã WB (FBO)
- **–ú–ü/FBS**: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚ùå –ù–ï –£–ß–ò–¢–´–í–ê–Æ–¢–°–Ø

### –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ:
```
WB:      3,459 –æ—Å—Ç–∞—Ç–∫–æ–≤
–¢–∞–±–ª–∏—Ü–∞:   475 –æ—Å—Ç–∞—Ç–∫–æ–≤
-------
–ü–æ—Ç–µ—Ä—è:  2,984 –æ—Å—Ç–∞—Ç–∫–æ–≤ (-86%)
```

---

## üîç –ö–û–†–ï–ù–¨ –ü–†–û–ë–õ–ï–ú–´

### –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–ù–ï–í–ï–†–ù–ê–Ø):

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ProductService.sync_from_api...    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                     ‚îÇ
‚îÇ  1. Warehouse API v1                ‚îÇ
‚îÇ     ‚îú‚îÄ FBO –æ—Å—Ç–∞—Ç–∫–∏ (—Å–∫–ª–∞–¥—ã WB)      ‚îÇ ‚Üê –¢–û–õ–¨–ö–û –≠–¢–ò –î–ê–ù–ù–´–ï
‚îÇ     ‚îî‚îÄ –ù–ï–¢ FBS/–ú–ü                   ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  2. Orders API v1                   ‚îÇ
‚îÇ     ‚îî‚îÄ –ó–∞–∫–∞–∑—ã (–≤—Å—ë –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)       ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  3. Calculate total_stock           ‚îÇ
‚îÇ     = sum(FBO –æ—Å—Ç–∞—Ç–∫–∏)              ‚îÇ ‚Üê –ù–ï–í–ï–†–ù–´–ô –†–ê–°–ß–Å–¢
‚îÇ     = 475 (–≤–º–µ—Å—Ç–æ 3,459)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

**Warehouse API v1** (`/api/v1/warehouse_remains`) –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
- ‚úÖ –û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ **—Å–∫–ª–∞–¥–∞—Ö Wildberries** (FBO)
- ‚ùå **–ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç** –æ—Å—Ç–∞—Ç–∫–∏ –Ω–∞ **–≤–∞—à–µ–º —Å–∫–ª–∞–¥–µ** (FBS/–ú–ü)

**Analytics API v2** (`/api/v2/stocks-report/products`) –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
- ‚úÖ –û—Å—Ç–∞—Ç–∫–∏ **FBO** (—Å–∫–ª–∞–¥—ã WB)
- ‚úÖ –û—Å—Ç–∞—Ç–∫–∏ **FBS/–ú–ü** (–≤–∞—à —Å–∫–ª–∞–¥)
- ‚úÖ **–ò–¢–û–ì–û** = FBO + FBS/–ú–ü = –ø–æ–ª–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏

**–ö–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:**
```python
# product_service.py:270-290
warehouse_remains = await self.wb_client.download_warehouse_remains(task_id)
# ‚Üê –≠—Ç–æ –¢–û–õ–¨–ö–û FBO –æ—Å—Ç–∞—Ç–∫–∏!

# –ó–∞—Ç–µ–º:
total_stock = sum(wh.get('quantity') for wh in warehouse['warehouses'])
# ‚Üê –°—É–º–º–∞ –¢–û–õ–¨–ö–û FBO –æ—Å—Ç–∞—Ç–∫–æ–≤ = 475 –≤–º–µ—Å—Ç–æ 3,459
```

---

## ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ProductService.sync_from_api... (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô)          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                          ‚îÇ
‚îÇ  1. Analytics API v2 (–ù–û–í–û–ï!)                           ‚îÇ
‚îÇ     ‚îî‚îÄ total_stock = 3,459 (FBO + FBS)                  ‚îÇ ‚Üê –ü–û–õ–ù–´–ï –û–°–¢–ê–¢–ö–ò
‚îÇ                                                          ‚îÇ
‚îÇ  2. Warehouse API v1                                    ‚îÇ
‚îÇ     ‚îî‚îÄ FBO breakdown –ø–æ —Å–∫–ª–∞–¥–∞–º WB = 475                 ‚îÇ ‚Üê BREAKDOWN FBO
‚îÇ                                                          ‚îÇ
‚îÇ  3. Calculate FBS/–ú–ü (–ù–û–í–û–ï!)                           ‚îÇ
‚îÇ     = total_stock - sum(FBO –æ—Å—Ç–∞—Ç–∫–∏)                    ‚îÇ
‚îÇ     = 3,459 - 475 = 2,984                               ‚îÇ ‚Üê –í–´–ß–ò–°–õ–Ø–ï–ú FBS
‚îÇ                                                          ‚îÇ
‚îÇ  4. Create Product                                       ‚îÇ
‚îÇ     ‚îú‚îÄ total_stock = 3,459 (–∏–∑ Analytics v2)            ‚îÇ
‚îÇ     ‚îú‚îÄ warehouses[FBO] = 475 (–∏–∑ Warehouse v1)          ‚îÇ
‚îÇ     ‚îî‚îÄ warehouses[FBS/–ú–ü] = 2,984 (–≤—ã—á–∏—Å–ª.)             ‚îÇ ‚Üê –í–°–ï –û–°–¢–ê–¢–ö–ò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîß –¢–†–ï–ë–£–ï–ú–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 1: –ü–æ–ª—É—á–∞—Ç—å total_stock –∏–∑ Analytics API v2

**–§–∞–π–ª**: `src/stock_tracker/services/product_service.py`  
**–ú–µ—Ç–æ–¥**: `sync_from_api_to_sheets()`

**–ë–´–õ–û:**
```python
async def sync_from_api_to_sheets(self, skip_existence_check: bool = False):
    # Step 1: Fetch warehouse remains (stocks) from V1 API
    warehouse_remains = await self.wb_client.download_warehouse_remains(task_id)
    
    # Calculate total_stock
    for record in warehouse_remains:
        total_stock = sum(wh.get('quantity') for wh in record['warehouses'])
        # ‚Üê –ù–ï–í–ï–†–ù–û: —Ç–æ–ª—å–∫–æ FBO –æ—Å—Ç–∞—Ç–∫–∏
```

**–î–û–õ–ñ–ù–û –ë–´–¢–¨:**
```python
async def sync_from_api_to_sheets(self, skip_existence_check: bool = False):
    # Step 1: Fetch FULL stocks from Analytics API v2
    analytics_data = await self.wb_client.get_all_product_stock_data()
    
    # Step 2: Fetch FBO warehouse breakdown from Warehouse API v1
    warehouse_remains = await self.wb_client.download_warehouse_remains(task_id)
    
    # Step 3: Combine data
    for analytics_item in analytics_data:
        nm_id = analytics_item.get('nmID')
        
        # –ü–û–õ–ù–´–ï –æ—Å—Ç–∞—Ç–∫–∏ –∏–∑ Analytics v2
        metrics = analytics_item.get('metrics', {})
        total_stock_full = metrics.get('stockCount', 0)  # FBO + FBS
        
        # FBO breakdown –∏–∑ Warehouse v1
        warehouse_record = find_warehouse_record(warehouse_remains, nm_id)
        fbo_warehouses = warehouse_record.get('warehouses', [])
        fbo_stock_sum = sum(wh.get('quantity') for wh in fbo_warehouses)
        
        # –í–´–ß–ò–°–õ–Ø–ï–ú FBS/–ú–ü –æ—Å—Ç–∞—Ç–∫–∏
        fbs_stock = total_stock_full - fbo_stock_sum
        
        # –°–æ–∑–¥–∞—ë–º Product —Å –ü–û–õ–ù–´–ú–ò –æ—Å—Ç–∞—Ç–∫–∞–º–∏
        product = Product(
            total_stock=total_stock_full,  # ‚Üê 3,459 –≤–º–µ—Å—Ç–æ 475
            warehouses=[
                *fbo_warehouses,  # FBO —Å–∫–ª–∞–¥—ã WB
                Warehouse(name="–ú–ü/FBS (–Ω–∞ —Å–∫–ª–∞–¥–µ –ø—Ä–æ–¥–∞–≤—Ü–∞)", 
                         stock=fbs_stock,  # ‚Üê 2,984
                         orders=fbs_orders)
            ]
        )
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 2: –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É "–ú–ü/FBS" –≤ —Ç–∞–±–ª–∏—Ü—É

–†–µ–∑—É–ª—å—Ç–∞—Ç –≤ Google Sheets –¥–æ–ª–∂–µ–Ω –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:

```
–ê—Ä—Ç–∏–∫—É–ª       | WB ID      | –ó–∞–∫–∞–∑—ã | –û—Å—Ç–∞—Ç–∫–∏ | –°–∫–ª–∞–¥—ã
              |            | (–≤—Å–µ–≥–æ)| (–≤—Å–µ–≥–æ) |
--------------+------------+--------+---------+------------------------
Its1_2_3/50g  | 163383326  | 105    | 3,459   | –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä: 11/51
              |            |        |         | –ß–µ—Ö–æ–≤ 1: 4/193
              |            |        |         | –†—è–∑–∞–Ω—å: 15/50
              |            |        |         | ...
              |            |        |         | –ú–ü/FBS: 0/2,984 ‚Üê –ù–û–í–û–ï!
```

---

## üìã –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### –§–∞–∑–∞ 1: –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (1-2 —á–∞—Å–∞)

1. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ `get_all_product_stock_data()` –≤ –Ω–∞—á–∞–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
2. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `metrics.stockCount` –¥–ª—è `total_stock`
3. ‚úÖ –í—ã—á–∏—Å–ª–∏—Ç—å FBS/–ú–ü –æ—Å—Ç–∞—Ç–∫–∏ = `total_stock - sum(FBO stocks)`
4. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å warehouse "–ú–ü/FBS (–Ω–∞ —Å–∫–ª–∞–¥–µ –ø—Ä–æ–¥–∞–≤—Ü–∞)" —Å –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–º–∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏

### –§–∞–∑–∞ 2: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (3-4 —á–∞—Å–∞)

1. –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Analytics API v2 –¥–∞–Ω–Ω—ã—Ö
2. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–±–∏–Ω–∞—Ü–∏—é –¥–≤—É—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
3. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é (total_stock >= sum(warehouse stocks))

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω—ã—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤

```python
# –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
product = operations.read_product(spreadsheet_id, "Its1_2_3/50g")

assert product.total_stock == 3459  # –ë—ã–ª–æ 475
assert len([wh for wh in product.warehouses if "–ú–ü/FBS" in wh.name]) == 1
```

### –¢–µ—Å—Ç 2: –°—É–º–º–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ —Å–∫–ª–∞–¥–∞–º = total_stock

```python
warehouse_stock_sum = sum(wh.stock for wh in product.warehouses)
assert warehouse_stock_sum == product.total_stock  # –î–æ–ª–∂–Ω–æ —Å—Ö–æ–¥–∏—Ç—å—Å—è
```

---

## üí∞ –í–õ–ò–Ø–ù–ò–ï –ù–ê –ë–ò–ó–ù–ï–°

### –î–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚ùå –û—Å—Ç–∞—Ç–∫–∏ –∑–∞–Ω–∏–∂–µ–Ω—ã –Ω–∞ **86%** (2,984 –∏–∑ 3,459)
- ‚ùå –ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫—É–ø–∫–∏
- ‚ùå –†–∏—Å–∫ —É–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂ (–Ω–µ –≤–∏–¥–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏)

### –ü–û–°–õ–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –û—Å—Ç–∞—Ç–∫–∏ **100% —Ç–æ—á–Ω—ã–µ** (3,459 —à—Ç)
- ‚úÖ –í–∏–¥–Ω—ã –æ—Å—Ç–∞—Ç–∫–∏ **FBO** –∏ **FBS/–ú–ü** –æ—Ç–¥–µ–ª—å–Ω–æ
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç–∏
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–æ–∫

---

## üéØ NEXT STEPS

1. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** —Å–æ–≥–ª–∞—Å–Ω–æ –ø–ª–∞–Ω—É
2. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** –Ω–∞ —Ç–æ–≤–∞—Ä–µ Its1_2_3/50g
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å** –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
4. **–û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é**

---

**–ê–≤—Ç–æ—Ä**: GitHub Copilot  
**–î–∞—Ç–∞**: 28 –æ–∫—Ç—è–±—Ä—è 2025  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô  
**–°—Ç–∞—Ç—É—Å**: –ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
