# История разработки Stock Tracker

Этот документ консолидирует историю ключевых исправлений, оптимизаций и фаз развития проекта Stock Tracker.

---

## Хронология основных вех

### Фаза 1: Базовая синхронизация и структура (начальная разработка)
- Создание базовой архитектуры `src/stock_tracker/`
- Интеграция Google Sheets API
- Первичная работа с Wildberries API v1
- Базовая модель Product, Warehouse

### Фаза 2: Устранение критических проблем с данными
**Отчёты:**
- `CRITICAL_FIXES_COMPLETION_REPORT.md`
- `CRITICAL_FIXES_FINAL_REPORT.md`
- `CRITICAL_ISSUES_SUMMARY.md`

**Проблемы:**
- Дублирование остатков по складам (проблема "in transit")
- Неправильная нормализация имён складов (Новосемейкино vs Самара)
- FBS товары теряли остатки маркетплейса
- Ошибки подсчёта заказов (orders)

**Решения:**
- Внедрение `warehouse_mapper` для нормализации имён
- Исправление логики `is_marketplace_warehouse()`
- Фильтрация складов "в пути" (не суммируются)
- Dual API подход (v1 + v3) для FBO/FBS

### Фаза 3: Dual API и FBS исправления
**Отчёты:**
- `DUAL_API_SUCCESS_REPORT.md`
- `FBS_PROBLEM_DETAILED_ANALYSIS.md`
- `MARKETPLACE_FIXES_COMPLETION_REPORT.md`

**Проблемы:**
- Артикулы "Its2/50g", "ItsSport2/50g" теряли FBS остатки (~2000+ единиц)
- API v1 не возвращал данные маркетплейса для всех артикулов
- Расхождения между CSV выгрузкой WB и данными API

**Решения:**
- Внедрение `DualAPIStockFetcher` (v1 + v3)
- Warehouse API v1 для FBO остатков
- Marketplace API v3 для FBS остатков (по баркодам)
- Объединение данных с дедупликацией

### Фаза 4: Оптимизация квот API
**Отчёты:**
- `API_QUOTA_ANALYSIS_REPORT.md`
- `API_QUOTA_OPTIMIZATION_PHASE1_COMPLETED.md`
- `PERFORMANCE_FIX_REPORT.md`

**Проблемы:**
- Превышение лимита 6 запросов/минуту к Marketplace API
- Медленная синхронизация большого каталога
- Избыточные запросы к Google Sheets

**Решения:**
- Батчинг запросов к Sheets (до 100 товаров за раз)
- Адаптивный rate limiter с экспоненциальным backoff
- Кэширование результатов API (опционально)
- Параллельная обработка с контролем потоков

### Фаза 5: Дедупликация и улучшение warehouse логики
**Отчёты:**
- `DEDUPLICATION_FIX_REPORT.md`
- `WAREHOUSE_FILTERING_COMPLETED.md`
- `WAREHOUSE_IMPROVEMENTS_COMPLETED.md`
- `WAREHOUSE_ORDERS_FIX_COMPLETE.md`

**Проблемы:**
- Дублирование товаров в таблице по nm_id + barcode
- Проблемные варианты складов (Обухово/Электросталь)
- Неверный подсчёт заказов по складам
- Смешение FBO/FBS остатков

**Решения:**
- Уникальность по `seller_article` + дедупликация nm_id
- Улучшенная нормализация складов через `warehouse_mapper`
- Раздельные колонки FBO/FBS в Google Sheets
- Корректный маппинг заказов к складам через warehouse_name

### Фаза 6: GitHub Actions и автоматизация
**Отчёты:**
- `GITHUB_ACTIONS_ARCHITECTURE.md`
- `GITHUB_ACTIONS_SETUP.md`
- `CHANGELOG_GITHUB_ACTIONS.md`

**Внедрено:**
- CI/CD через GitHub Actions
- Автоматическая синхронизация по расписанию (каждые 6 часов)
- Уведомления об ошибках
- Secrets management для API ключей
- Документация быстрого старта

### Фаза 7: Финализация и стабилизация
**Отчёты:**
- `FINAL_SUCCESS_REPORT.md`
- `FINAL_SUCCESS_REPORT_30_OCT_2025.md`
- `FINAL_PROJECT_REPORT.md`

**Достигнуто:**
- 100% соответствие данных между WB API и таблицей
- Устранение всех критических расхождений
- Стабильная работа синхронизации
- Полное покрытие тестами (pytest)
- Документация пользователя и разработчика

---

## Ключевые улучшения кода

### Архитектура
- Модульная структура `src/stock_tracker/`
- Разделение: core models, services, database, utils
- Dependency injection через config
- Чёткое разделение ответственности

### Качество данных
- Нормализация складов (единый маппер)
- Dual API подход для покрытия FBO + FBS
- Дедупликация по seller_article
- Валидация данных перед записью в Sheets

### Производительность
- Батчинг операций (API + Sheets)
- Rate limiting с адаптивной задержкой
- Минимизация вызовов API
- Кэширование (опционально)

### Надёжность
- Retry механизм с экспоненциальным backoff
- Graceful degradation при ошибках API
- Логирование всех критических операций
- Валидация конфигурации при старте

### Тестирование
- Unit тесты для core логики
- Integration тесты для API
- Mock тесты для Sheets операций
- Регрессионные тесты для критических сценариев

---

## Текущее состояние (ноябрь 2025)

### Стабильные компоненты
- ✅ Dual API синхронизация (v1 + v3)
- ✅ Google Sheets интеграция
- ✅ Warehouse нормализация и фильтрация
- ✅ FBO/FBS разделение
- ✅ Orders подсчёт и маппинг
- ✅ GitHub Actions автоматизация
- ✅ Rate limiting и батчинг

### Известные ограничения
- Wildberries API v1 может не возвращать все FBS данные для некоторых артикулов
- Квота 6 req/min на Marketplace API требует батчинга больших каталогов
- CSV выгрузки WB могут отличаться от API (разные источники данных)

### Рекомендации по дальнейшему развитию
1. **Мониторинг:** добавить Grafana/Prometheus для трекинга метрик
2. **Алерты:** настроить уведомления в Telegram/Slack при критических ошибках
3. **Кэширование:** внедрить Redis для кэширования API ответов (снизит нагрузку)
4. **Аналитика:** добавить дашборды с метриками оборачиваемости и stock alerts
5. **Масштабирование:** переход на async/await для параллельных запросов

---

## Архивные материалы

Все промежуточные отчёты, тестовые скрипты и одноразовые проверки перенесены в `archive/`:
- `archive/analysis/` — аналитические скрипты
- `archive/checks/` — проверки структуры
- `archive/debug/` — отладочные утилиты
- `archive/fixes/` — одноразовые исправления
- `archive/verification/` — финальные верификации
- `archive/legacy/` — устаревшие версии

Детальная структура и политика хранения описаны в `archive/README.md`.

---

## Контакты и поддержка

- Repository: [ameba7464/Stock-Tracker-](https://github.com/ameba7464/Stock-Tracker-)
- Issues: используйте GitHub Issues для багов и feature requests
- Документация: см. `README.md`, `QUICK_SETUP.md`, `SETUP_GUIDE.md`

---

_Последнее обновление: 15 ноября 2025_
