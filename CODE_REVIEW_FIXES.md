# –ö–æ–¥-—Ä–µ–≤—å—é –∏ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**–î–∞—Ç–∞:** 25 –¥–µ–∫–∞–±—Ä—è 2025 –≥.

---

## üêõ –ù–∞–π–¥–µ–Ω–Ω—ã–µ –û—à–∏–±–∫–∏

### 1. ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø: start.py –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—É—é –ø—Ä–æ–≤–µ—Ä–∫—É

**–§–∞–π–ª:** `telegram-bot/app/bot/handlers/start.py:35`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
if user and user.payment_status == 'completed':
```

–ö–æ–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–µ–µ –ø–æ–ª–µ `payment_status` –≤–º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è unified —Ñ—É–Ω–∫—Ü–∏–∏ `check_user_access()`.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ò–º–ø–æ—Ä—Ç –≤–≤–µ—Ä—Ö—É —Ñ–∞–π–ª–∞
from app.services.subscription import check_user_access

# –í —Ñ—É–Ω–∫—Ü–∏–∏ cmd_start
if user:
    has_access = await check_user_access(user.id, session)
    if has_access:
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
```

---

### 2. ‚ö†Ô∏è –í–ê–ñ–ù–ê–Ø: –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ subscription.py

**–§–∞–π–ª:** `telegram-bot/app/services/subscription.py:23-56`

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–ª–æ–∫ –∫–æ–¥–∞ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –¥–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å Subscription, —Ö–æ—Ç—è –æ–Ω–∞ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ models.py.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, —Ç–∞–∫ –∫–∞–∫ –º–æ–¥–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.

---

### 3. ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: Nullable –ø–æ–ª—è –≤ Subscription

**–§–∞–π–ª:** `telegram-bot/app/database/models.py:88-95`

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í—Å–µ –¥–∞—Ç—ã –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–µ–π –∏–º–µ—é—Ç `nullable=True`, –Ω–æ –Ω–µ—Ç —è–≤–Ω–æ–≥–æ `Optional` –≤ —Ç–∏–ø–∞—Ö.

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
trial_ends_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), nullable=True)
```

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥:**
```python
trial_ends_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)
```

–ù—É–∂–µ–Ω –∏–º–ø–æ—Ä—Ç `Optional` –∏–∑ `typing`.

---

### 4. ‚ö†Ô∏è –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å: status –∫–∞–∫ String –≤–º–µ—Å—Ç–æ Enum

**–§–∞–π–ª:** `telegram-bot/app/database/models.py:79-83`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
status: Mapped[str] = mapped_column(String(20), ...)
```

–û–ø—Ä–µ–¥–µ–ª–µ–Ω enum `SubscriptionStatus`, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –º–æ–¥–µ–ª–∏. –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
status: Mapped[str] = mapped_column(
    SQLEnum(SubscriptionStatus, name='subscription_status'),
    nullable=False,
    default=SubscriptionStatus.FREE,
    index=True
)
```

–ù–æ –í–ù–ò–ú–ê–ù–ò–ï: –í –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π enum 'subscription_status'. –ù—É–∂–Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å!

---

### 5. ‚ÑπÔ∏è –ó–∞–º–µ—á–∞–Ω–∏–µ: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–º–ø–æ—Ä—Ç Subscription

**–§–∞–π–ª:** `telegram-bot/app/services/subscription.py`

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –¥–µ–ª–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç:
```python
from app.database.models import Subscription
```

–≠—Ç–æ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è 5 —Ä–∞–∑ –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
–í—ã–Ω–µ—Å—Ç–∏ –∏–º–ø–æ—Ä—Ç –Ω–∞–≤–µ—Ä—Ö —Ñ–∞–π–ª–∞ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º –æ —Ç–æ–º, –ø–æ—á–µ–º—É –æ–Ω –ª–æ–∫–∞–ª—å–Ω—ã–π (–µ—Å–ª–∏ –µ—Å—Ç—å circular import).

---

## ‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

- ‚úÖ `subscription.py` ‚Äî —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
- ‚úÖ `models.py` ‚Äî —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω  
- ‚úÖ `registration.py` ‚Äî —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
- ‚úÖ `menu.py` ‚Äî —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
- ‚úÖ `config.py` ‚Äî —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
- ‚ùå `start.py` ‚Äî –ª–æ–≥–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ (—Å—Ç–∞—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)

---

## üîÑ –°–ø–∏—Å–æ–∫ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ (Critical):

1. **–û–±–Ω–æ–≤–∏—Ç—å start.py** –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `check_user_access()`
2. **–î–æ–±–∞–≤–∏—Ç—å Optional** –≤ —Ç–∏–ø—ã nullable –ø–æ–ª–µ–π Subscription
3. **–£–¥–∞–ª–∏—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏** –∏–∑ subscription.py

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ (Recommended):

4. **–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∏–º–ø–æ—Ä—Ç—ã** Subscription –≤ subscription.py
5. **–†–µ—à–∏—Ç—å –≤–æ–ø—Ä–æ—Å —Å enum** –¥–ª—è status (String vs SQLEnum)

---

## üìã –ü–ª–∞–Ω –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –®–∞–≥ 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å start.py

```python
# –ë—ã–ª–æ:
if user and user.payment_status == 'completed':
    
# –°—Ç–∞–ª–æ:
from app.services.subscription import check_user_access

if user:
    has_access = await check_user_access(user.id, session)
    if has_access:
```

### –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å Optional –≤ models.py

```python
from typing import Optional

# –î–ª—è –≤—Å–µ—Ö nullable –ø–æ–ª–µ–π –≤ Subscription:
trial_ends_at: Mapped[Optional[datetime]] = ...
subscription_starts_at: Mapped[Optional[datetime]] = ...
subscription_ends_at: Mapped[Optional[datetime]] = ...
payment_provider: Mapped[Optional[str]] = ...
payment_external_id: Mapped[Optional[str]] = ...
last_payment_at: Mapped[Optional[datetime]] = ...
```

### –®–∞–≥ 3: –û—á–∏—Å—Ç–∏—Ç—å subscription.py

–£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ 23-56 (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π).

### –®–∞–≥ 4: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∏–º–ø–æ—Ä—Ç–æ–≤

```python
# –í –Ω–∞—á–∞–ª–µ subscription.py –¥–æ–±–∞–≤–∏—Ç—å:
from app.database.models import User, Subscription

# –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–π
```

---

## ‚öôÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –ú–∏–≥—Ä–∞—Ü–∏–∏

### –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:

**–§–∞–π–ª:** `migrations/versions/20251225_unify_subscriptions.py:18`

```python
down_revision = None  # TODO: Update to latest migration ID before running
```

**–î–µ–π—Å—Ç–≤–∏–µ:**
–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:
```bash
alembic current
# –í—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ down_revision
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ü–æ—Å–ª–µ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –¢–µ—Å—Ç 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```python
# –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:
1. –°–æ–∑–¥–∞–µ—Ç—Å—è User
2. –°–æ–∑–¥–∞–µ—Ç—Å—è Subscription —Å status='FREE', has_access=True
3. check_user_access() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç True (payment_enabled=False)
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è Google Sheet
```

### –¢–µ—Å—Ç 2: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
```python
# –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:
1. /start –∫–æ–º–∞–Ω–¥–∞
2. check_user_access() –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É
3. –ï—Å–ª–∏ has_access=True ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é
4. –ï—Å–ª–∏ has_access=False ‚Üí –ø—Ä–æ—Å–∏—Ç –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É (–ø—Ä–∏ payment_enabled=True)
```

### –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ–Ω—é
```python
# –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:
1. –ö–Ω–æ–ø–∫–∞ "–ü–æ–ª—É—á–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å–Ω–æ–≤–∞"
2. check_user_access() –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø
3. –ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É
4. –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–¥–ø–∏—Å–∫–µ
```

---

## üìä –û—Ü–µ–Ω–∫–∞ –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏

| –û—à–∏–±–∫–∞ | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å | –í–ª–∏—è–Ω–∏–µ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|--------|-------------|---------|-----------|
| start.py –ø—Ä–æ–≤–µ—Ä–∫–∞ | üî¥ –í–´–°–û–ö–ê–Ø | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ —Å–º–æ–≥—É—Ç –≤–æ–π—Ç–∏ –≤ –±–æ—Ç | P0 |
| Optional —Ç–∏–ø—ã | üü° –°–†–ï–î–ù–Ø–Ø | –ú–æ–≥—É—Ç –±—ã—Ç—å –æ—à–∏–±–∫–∏ type checking | P1 |
| –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ | üü¢ –ù–ò–ó–ö–ê–Ø | –¢–æ–ª—å–∫–æ —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∫–æ–¥–∞ | P2 |
| –ò–º–ø–æ—Ä—Ç—ã | üü¢ –ù–ò–ó–ö–ê–Ø | –ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ | P3 |

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π –ß–µ–∫-–ª–∏—Å—Ç

- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å start.py (check_user_access)
- [ ] –î–æ–±–∞–≤–∏—Ç—å Optional –≤ models.py
- [ ] –£–¥–∞–ª–∏—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–∑ subscription.py
- [ ] –û–±–Ω–æ–≤–∏—Ç—å down_revision –≤ –º–∏–≥—Ä–∞—Ü–∏–∏
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –º–µ–Ω—é
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏

---

**–°—Ç–∞—Ç—É—Å:** –ù–∞–π–¥–µ–Ω–æ 5 –ø—Ä–æ–±–ª–µ–º (1 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è, 2 –≤–∞–∂–Ω—ã—Ö, 2 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)  
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
