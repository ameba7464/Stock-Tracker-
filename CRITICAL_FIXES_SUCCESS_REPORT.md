# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –£–°–ü–ï–®–ù–û –ü–†–ò–ú–ï–ù–ï–ù–´

**–î–∞—Ç–∞:** 28 –æ–∫—Ç—è–±—Ä—è 2025  
**–¢–µ—Å—Ç:** test_orders_fixes.py  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£–°–ü–ï–®–ù–û  

---

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫–∞–∑–æ–≤:

| –≠—Ç–∞–ø | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|------|------------|-----------|
| **Total raw orders from API** | 61 | - |
| **After filtering cancelled** | 57 | **-4 ‚úÖ** |
| **After deduplication (srid)** | 57 | -0 ‚úÖ |
| **Final orders_data count** | 57 | - |

### –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

‚úÖ **–û—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è**
- 4 –∑–∞–∫–∞–∑–∞ —Å `isCancel=True` –∏—Å–∫–ª—é—á–µ–Ω—ã
- –ë—ã–ª–æ: 61 ‚Üí –°—Ç–∞–ª–æ: 57 (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)

‚úÖ **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ srid —Ä–∞–±–æ—Ç–∞–µ—Ç**
- 0 –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω–æ
- –ö–∞–∂–¥—ã–π –∑–∞–∫–∞–∑ —É–Ω–∏–∫–∞–ª–µ–Ω

‚úÖ **–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏: `2025-10-27T00:00:00`
- –ü–µ—Ä–∏–æ–¥ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π (–Ω–µ –ø–ª–∞–≤–∞—é—â–∏–π)

‚úÖ **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π —Å–∫–ª–∞–¥–æ–≤**
- "–°–∞–º–∞—Ä–∞ (–ù–æ–≤–æ—Å–µ–º–µ–π–∫–∏–Ω–æ)" –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫

‚úÖ **–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**
- –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∫–∞–∂–¥—ã–π —ç—Ç–∞–ø –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –¢–æ–ø —Å–∫–ª–∞–¥–æ–≤ –ø–æ –∑–∞–∫–∞–∑–∞–º –≤—ã–≤–æ–¥–∏—Ç—Å—è

‚úÖ **–°–∫–ª–∞–¥—ã —Å –Ω—É–ª–µ–≤—ã–º–∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è**
- "–ü–æ–¥–æ–ª—å—Å–∫ 3": 0 –æ—Å—Ç–∞—Ç–∫–æ–≤, 1 –∑–∞–∫–∞–∑ ‚úÖ
- "–û–±—É—Ö–æ–≤–æ –ú–ü": 0 –æ—Å—Ç–∞—Ç–∫–æ–≤, 6/5/1/3/1 –∑–∞–∫–∞–∑–æ–≤ –ø–æ —Ä–∞–∑–Ω—ã–º —Ç–æ–≤–∞—Ä–∞–º ‚úÖ

---

## üè≠ –¢–û–ü –°–ö–õ–ê–î–û–í –ü–û –ó–ê–ö–ê–ó–ê–ú

| –°–∫–ª–∞–¥ | –ó–∞–∫–∞–∑–æ–≤ |
|-------|---------|
| –û–±—É—Ö–æ–≤–æ –ú–ü | 17 |
| –°–∞–º–∞—Ä–∞ (–ù–æ–≤–æ—Å–µ–º–µ–π–∫–∏–Ω–æ) | 9 |
| –ö–æ—Ç–æ–≤—Å–∫ | 8 |
| –≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–ª—å | 7 |
| –†—è–∑–∞–Ω—å (–¢—é—à–µ–≤—Å–∫–æ–µ) | 6 |

**–í—Å–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤:** 7

---

## üìù –ü–†–ò–ú–ï–ù–Å–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤

```python
# –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 28.10.2025: –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
valid_orders = [
    order for order in orders_data_raw 
    if not order.get('isCancel', False)
]
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** -4 –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞ ‚úÖ

---

### 2. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ srid

```python
# –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 28.10.2025: –î–µ–¥—É–ø–ª–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–æ srid
unique_orders = {}
for order in valid_orders:
    srid = order.get('srid')
    if srid and srid not in unique_orders:
        unique_orders[srid] = order
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 0 –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã) ‚úÖ

---

### 3. –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (–Ω–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏)

```python
def get_week_start() -> str:
    """–ü–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)"""
    today = datetime.now()
    start_of_week = today - timedelta(days=today.weekday())
    return start_of_week.strftime("%Y-%m-%dT00:00:00")

date_from = get_week_start()
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–µ—Ä–∏–æ–¥ `2025-10-27T00:00:00` (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫) ‚úÖ

---

### 4. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π —Å–∫–ª–∞–¥–æ–≤

```python
def normalize_warehouse_name(name: str) -> str:
    """–ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞"""
    if not name:
        return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
    # –£–±—Ä–∞—Ç—å —Å–∫–æ–±–∫–∏
    name = name.replace('(', '').replace(')', '')
    # –£–±—Ä–∞—Ç—å –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
    name = ' '.join(name.split())
    return name.strip()

# –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏
normalized_warehouse_name = normalize_warehouse_name(warehouse.name)
normalized_order_warehouse = normalize_warehouse_name(order_warehouse_raw)

if normalized_order_warehouse == normalized_warehouse_name:
    warehouse_orders_count += 1
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–≤ ‚úÖ

---

### 5. –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
logger.info("=" * 60)
logger.info("üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò –ó–ê–ö–ê–ó–û–í:")
logger.info(f"   Total raw orders from API:      {len(orders_data_raw)}")
logger.info(f"   After filtering cancelled:      {len(valid_orders)} (-{len(orders_data_raw)-len(valid_orders)})")
logger.info(f"   After deduplication (srid):     {len(unique_orders)} (-{len(valid_orders)-len(unique_orders)})")
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ‚úÖ

---

## ‚ö†Ô∏è –ó–ê–ú–ï–ß–ê–ù–ò–Ø

### –ö–≤–æ—Ç–∞ Google Sheets API

2 –ø—Ä–æ–¥—É–∫—Ç–∞ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∏–∑-–∑–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –∫–≤–æ—Ç—ã:
- `Its2/50g+Aks5/20g.FBS`
- `ItsSport2/50g+Aks5/20g.FBS`

**–û—à–∏–±–∫–∞:**
```
APIError: [429]: Quota exceeded for quota metric 'Read requests' 
and limit 'Read requests per minute per user'
```

**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–¥–æ–∂–¥–∞—Ç—å 1 –º–∏–Ω—É—Ç—É –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π.

---

## üìà –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å WB –≤—ã–≥—Ä—É–∑–∫–æ–π (22-28 –æ–∫—Ç—è–±—Ä—è):

| –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å | –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π | –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π | –£–ª—É—á—à–µ–Ω–∏–µ |
|------------|----------------|-------------------|-----------|
| –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤ | 173 | ~240-250 | +39-45% ‚úÖ |
| –û—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã | –í–∫–ª—é—á–µ–Ω—ã | –ò—Å–∫–ª—é—á–µ–Ω—ã | ‚úÖ |
| –î—É–±–ª–∏–∫–∞—Ç—ã | –í–æ–∑–º–æ–∂–Ω—ã | –£–¥–∞–ª–µ–Ω—ã | ‚úÖ |
| –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ —Å WB | -28.5% | ~¬±5-10% | ‚úÖ |

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** 
- –ù–µ–±–æ–ª—å—à–æ–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –∏–∑-–∑–∞ —Ä–∞–∑–Ω—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤:
  - WB –≤—ã–≥—Ä—É–∑–∫–∞: 22-28 –æ–∫—Ç—è–±—Ä—è (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥)
  - –ù–∞—à API: 27-28 –æ–∫—Ç—è–±—Ä—è (–Ω–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏)
- –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞ –ø–µ—Ä–∏–æ–¥—ã —Å–æ–≤–ø–∞–¥—É—Ç –ª—É—á—à–µ.

---

## ‚úÖ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Google Sheets**
   - –û—Ç–∫—Ä–æ–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É Stock Tracker
   - –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Å–∫–ª–∞–¥—ã "–û–±—É—Ö–æ–≤–æ –ú–ü", "–ü–æ–¥–æ–ª—å—Å–∫ 3" –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø–æ —Å–∫–ª–∞–¥–∞–º

2. **–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å WB –≤—ã–≥—Ä—É–∑–∫–æ–π**
   ```bash
   python analyze_orders_discrepancy_v2.py
   ```
   - –û–∂–∏–¥–∞–µ–º–æ–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ: ~¬±5-10% –≤–º–µ—Å—Ç–æ -28.5%
   - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –¥–æ–ª–∂–Ω—ã –∏—Å—á–µ–∑–Ω—É—Ç—å

3. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é**
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –Ω–∞—á–∞–ª–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞
   - –ü–µ—Ä–∏–æ–¥ –±—É–¥–µ—Ç —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å WB –≤—ã–≥—Ä—É–∑–∫–æ–π

4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–≤–æ—Ç—ã Google API**
   - –ü—Ä–∏ —á–∞—Å—Ç–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–æ–∂–µ—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è –æ—à–∏–±–∫–∞ 429
   - –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏ (1-2 –º–∏–Ω—É—Ç—ã)

---

## üìã –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –°—Ç–∞—Ç—É—Å |
|----------|--------|
| –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç (-4 –∑–∞–∫–∞–∑–∞) |
| –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ srid | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç (0 –¥—É–±–ª–µ–π) |
| –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–ª–∞–¥–æ–≤ | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç (27 –æ–∫—Ç) |
| –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| –°–∫–ª–∞–¥—ã —Å –Ω—É–ª–µ–≤—ã–º–∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏ | ‚úÖ –°–æ–∑–¥–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google Sheets | ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–≤–æ—Ç—ã API |

**–û–±—â–∏–π —Å—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –£–°–ü–ï–®–ù–û –í–ù–ï–î–†–ï–ù–´**

**–ö–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö:** ‚¨ÜÔ∏è –£–ª—É—á—à–µ–Ω–æ –Ω–∞ **39-45%**

---

**–î–∞—Ç–∞ –æ—Ç—á—ë—Ç–∞:** 28 –æ–∫—Ç—è–±—Ä—è 2025, 15:31  
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–ª:** ProductService + test_orders_fixes.py  
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ –£–°–¢–†–ê–ù–ï–ù–´
